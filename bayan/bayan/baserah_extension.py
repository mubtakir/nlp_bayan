"""
امتداد بصيرة للمفسر - Baserah Extension for Interpreter
========================================================

ربط نظام بصيرة (الذكاء الرياضي) بمفسر البيان.
يُحمّل الدوال في البيئة العامة للمفسر دون تعديل ملف المفسر.

المؤلف: باسل يحيى عبدالله
"""

import numpy as np
from typing import Dict, Any, List

# استيراد مكونات بصيرة
from .baserah_ai import (
    AdaptiveEquation, AdaptationType,
    RevolutionaryLeadership, LeadershipMode,
    DrawingUnit, InferenceUnit, ShapeGenerator,
    ShapeType, ShapeSpec,
    GeneralizedSigmoid, SigmoidParameters,
    REVOLUTIONARY_THEORIES, create_baserah_system
)

from .baserah_ai.advanced import (
    ThinkingCore, LayerType,
    ConsciousnessSystem, AttentionLevel
)


def inject_baserah_functions(global_env: Dict[str, Any]):
    """
    حقن دوال بصيرة في البيئة العامة للمفسر
    
    يُستدعى من المفسر عند التهيئة
    """
    
    # ═══════════════════════════════════════════════════════════════
    # 1. دوال المعادلات المتكيفة
    # ═══════════════════════════════════════════════════════════════
    
    def أنشئ_معادلة_متكيفة(الاسم: str, alpha=None, k=None, beta=None):
        """إنشاء معادلة متكيفة جديدة"""
        return AdaptiveEquation(الاسم, alpha, k, beta)
    
    def كيّف_المعادلة(معادلة: AdaptiveEquation, النوع: str = "صفري"):
        """تكييف المعادلة"""
        types = {"صفري": AdaptationType.ZERO_DUALITY,
                 "تعامدي": AdaptationType.PERPENDICULAR}
        return معادلة.adapt(types.get(النوع, AdaptationType.ZERO_DUALITY))
    
    # ═══════════════════════════════════════════════════════════════
    # 2. دوال القيادة الثورية
    # ═══════════════════════════════════════════════════════════════
    
    def أنشئ_قيادة_ثورية():
        """إنشاء نظام قيادة ثورية"""
        return RevolutionaryLeadership()
    
    def طبّق_ثنائية_الصفر(قيادة: RevolutionaryLeadership, قيمة):
        """تطبيق نظرية ثنائية الصفر"""
        return قيادة.apply_zero_duality(قيمة)
    
    def طبّق_تعامد_الأضداد(قيادة: RevolutionaryLeadership, مفهوم, ضد=None):
        """تطبيق نظرية تعامد الأضداد"""
        return قيادة.apply_perpendicular(مفهوم, ضد)
    
    def طبّق_نظرية_الفتائل(قيادة: RevolutionaryLeadership, تعقيد: int = 1):
        """تطبيق نظرية الفتائل"""
        return قيادة.apply_filament(تعقيد)
    
    # ═══════════════════════════════════════════════════════════════
    # 3. دوال الوحدة الفنية
    # ═══════════════════════════════════════════════════════════════
    
    def أنشئ_وحدة_رسم():
        """إنشاء وحدة رسم"""
        return DrawingUnit()
    
    def ارسم_شكلاً(النوع: str, الحجم: float = 1.0):
        """رسم شكل معين"""
        drawer = DrawingUnit()
        shapes = {
            "دائرة": lambda: drawer.draw_circle(الحجم),
            "قلب": lambda: drawer.draw_heart(الحجم),
            "وردة": lambda: drawer.draw_flower(5, الحجم),
            "حلزون": lambda: drawer.draw_spiral(3, الحجم * 0.1),
            "موجة": lambda: drawer.draw_wave(1, الحجم)
        }
        return shapes.get(النوع, shapes["دائرة"])()
    
    def استنبط_معادلة(x: list, y: list):
        """استنباط معادلة من نقاط"""
        inference = InferenceUnit()
        return inference.infer_from_points(np.array(x), np.array(y))
    
    # ═══════════════════════════════════════════════════════════════
    # 4. دوال التفكير والوعي
    # ═══════════════════════════════════════════════════════════════
    
    def أنشئ_نواة_تفكير():
        """إنشاء نواة تفكير متعددة الطبقات"""
        return ThinkingCore()
    
    def فكّر(نواة: ThinkingCore, بيانات):
        """معالجة البيانات عبر طبقات التفكير"""
        return نواة.process(بيانات)
    
    def أنشئ_نظام_وعي():
        """إنشاء نظام وعي وانتباه"""
        return ConsciousnessSystem()
    
    def ركّز_على(وعي: ConsciousnessSystem, هدف, أولوية: float = 1.0):
        """التركيز على هدف"""
        return وعي.focus_on(هدف, أولوية)
    
    # ═══════════════════════════════════════════════════════════════
    # 5. دالة إنشاء النظام المتكامل
    # ═══════════════════════════════════════════════════════════════
    
    def أنشئ_نظام_بصيرة(الاسم: str = "بصيرة"):
        """إنشاء نظام بصيرة متكامل"""
        return create_baserah_system(الاسم)
    
    # ═══════════════════════════════════════════════════════════════
    # حقن الدوال في البيئة العامة
    # ═══════════════════════════════════════════════════════════════
    
    functions = {
        # المعادلات المتكيفة
        "أنشئ_معادلة_متكيفة": أنشئ_معادلة_متكيفة,
        "كيّف_المعادلة": كيّف_المعادلة,
        
        # القيادة الثورية
        "أنشئ_قيادة_ثورية": أنشئ_قيادة_ثورية,
        "طبّق_ثنائية_الصفر": طبّق_ثنائية_الصفر,
        "طبّق_تعامد_الأضداد": طبّق_تعامد_الأضداد,
        "طبّق_نظرية_الفتائل": طبّق_نظرية_الفتائل,
        
        # الوحدة الفنية
        "أنشئ_وحدة_رسم": أنشئ_وحدة_رسم,
        "ارسم_شكلاً": ارسم_شكلاً,
        "استنبط_معادلة": استنبط_معادلة,
        
        # التفكير والوعي
        "أنشئ_نواة_تفكير": أنشئ_نواة_تفكير,
        "فكّر": فكّر,
        "أنشئ_نظام_وعي": أنشئ_نظام_وعي,
        "ركّز_على": ركّز_على,
        
        # النظام المتكامل
        "أنشئ_نظام_بصيرة": أنشئ_نظام_بصيرة,
        
        # الثوابت
        "النظريات_الثورية": REVOLUTIONARY_THEORIES,
    }
    
    global_env.update(functions)
    return list(functions.keys())


# قائمة الدوال للتصدير
BASERAH_FUNCTIONS = [
    "أنشئ_معادلة_متكيفة", "كيّف_المعادلة",
    "أنشئ_قيادة_ثورية", "طبّق_ثنائية_الصفر", 
    "طبّق_تعامد_الأضداد", "طبّق_نظرية_الفتائل",
    "أنشئ_وحدة_رسم", "ارسم_شكلاً", "استنبط_معادلة",
    "أنشئ_نواة_تفكير", "فكّر",
    "أنشئ_نظام_وعي", "ركّز_على",
    "أنشئ_نظام_بصيرة"
]

