/**
 * Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© - Knowledge Base
 * 
 * ğŸ“š Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ø¸Ù…Ø© Ù„Ù„Ù…Ø¹Ø±ÙØ©
 * ğŸ”— Ø±Ø¨Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© Ø¨Ø¨Ø¹Ø¶Ù‡Ø§
 * ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…
 * 
 * @author Ø¨Ø§Ø³Ù„ ÙŠØ­ÙŠÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡
 * @version 1.0.0
 * @date 2025-10-27
 */

import { MotherEquation } from "../core/mother-equation.bn";
import { KnowledgeItem, KnowledgeCategory, KnowledgeLevel } from "./knowledge-feeding-system.bn";

/**
 * Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ©
 */
enum RelationType {
    IS_A = "is_a",                    // Ù‡Ùˆ Ù†ÙˆØ¹ Ù…Ù†
    PART_OF = "part_of",              // Ø¬Ø²Ø¡ Ù…Ù†
    RELATED_TO = "related_to",        // Ù…Ø±ØªØ¨Ø· Ø¨Ù€
    DEPENDS_ON = "depends_on",        // ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰
    CONTRADICTS = "contradicts",      // ÙŠÙ†Ø§Ù‚Ø¶
    SUPPORTS = "supports",            // ÙŠØ¯Ø¹Ù…
    EXAMPLE_OF = "example_of",        // Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰
    DERIVED_FROM = "derived_from"     // Ù…Ø´ØªÙ‚ Ù…Ù†
}

/**
 * ÙØ¦Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© - KnowledgeRelation
 */
class KnowledgeRelation extends MotherEquation {
    public relationId: string;
    public sourceItemId: string;
    public targetItemId: string;
    public relationType: RelationType;
    public strength: number;  // 0.0 - 1.0
    public bidirectional: boolean;
    public metadata: object;
    public creationTime: Date;
    
    constructor(
        sourceItemId: string,
        targetItemId: string,
        relationType: RelationType,
        strength: number = 1.0
    ) {
        super(`relation_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`);
        
        this.relationId = this.id;
        this.sourceItemId = sourceItemId;
        this.targetItemId = targetItemId;
        this.relationType = relationType;
        this.strength = Math.max(0, Math.min(1, strength));
        this.bidirectional = false;
        this.metadata = {};
        this.creationTime = new Date();
    }
}

/**
 * ÙØ¦Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© - KnowledgeCluster
 */
class KnowledgeCluster extends MotherEquation {
    public clusterId: string;
    public name: string;
    public description: string;
    public itemIds: Set<string>;
    public category: KnowledgeCategory;
    public tags: array<string>;
    public creationTime: Date;
    public lastModified: Date;
    
    constructor(name: string, category: KnowledgeCategory) {
        super(`cluster_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`);
        
        this.clusterId = this.id;
        this.name = name;
        this.description = "";
        this.itemIds = new Set();
        this.category = category;
        this.tags = [];
        this.creationTime = new Date();
        this.lastModified = new Date();
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
     */
    public addItem(itemId: string): void {
        this.itemIds.add(itemId);
        this.lastModified = new Date();
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
     */
    public removeItem(itemId: string): void {
        this.itemIds.delete(itemId);
        this.lastModified = new Date();
    }
    
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†ØµØ±
     */
    public hasItem(itemId: string): boolean {
        return this.itemIds.has(itemId);
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
     */
    public getItemCount(): number {
        return this.itemIds.size;
    }
}

/**
 * ÙØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© - KnowledgeBase
 */
class KnowledgeBase {
    private items: Map<string, KnowledgeItem>;
    private relations: Map<string, KnowledgeRelation>;
    private clusters: Map<string, KnowledgeCluster>;
    private itemsByCategory: Map<KnowledgeCategory, Set<string>>;
    private itemsByLevel: Map<KnowledgeLevel, Set<string>>;
    private itemsByTag: Map<string, Set<string>>;
    private creationTime: Date;
    
    /**
     * Ø§Ù„Ù…ÙÙ†Ø´Ø¦
     */
    constructor() {
        this.items = new Map();
        this.relations = new Map();
        this.clusters = new Map();
        this.itemsByCategory = new Map();
        this.itemsByLevel = new Map();
        this.itemsByTag = new Map();
        this.creationTime = new Date();
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ‡Ø§Ø±Ø³
        this.initializeIndexes();
        
        console.log("ğŸ“š ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©");
    }
    
    /**
     * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ‡Ø§Ø±Ø³
     */
    private initializeIndexes(): void {
        // ÙÙ‡Ø±Ø³ Ø§Ù„ÙØ¦Ø§Øª
        for (let category in KnowledgeCategory) {
            this.itemsByCategory.set(KnowledgeCategory[category], new Set());
        }
        
        // ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        for (let level in KnowledgeLevel) {
            this.itemsByLevel.set(KnowledgeLevel[level], new Set());
        }
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù…Ø¹Ø±ÙÙŠ
     */
    public addItem(item: KnowledgeItem): string {
        this.items.set(item.itemId, item);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø§Ø±Ø³
        this.updateIndexes(item);
        
        console.log(`   âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±: ${item.title}`);
        return item.itemId;
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø§Ø±Ø³
     */
    private updateIndexes(item: KnowledgeItem): void {
        // ÙÙ‡Ø±Ø³ Ø§Ù„ÙØ¦Ø©
        let categorySet = this.itemsByCategory.get(item.category);
        if (categorySet) {
            categorySet.add(item.itemId);
        }
        
        // ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        let levelSet = this.itemsByLevel.get(item.level);
        if (levelSet) {
            levelSet.add(item.itemId);
        }
        
        // ÙÙ‡Ø±Ø³ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
        for (let tag of item.tags) {
            if (!this.itemsByTag.has(tag)) {
                this.itemsByTag.set(tag, new Set());
            }
            this.itemsByTag.get(tag)!.add(item.itemId);
        }
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ù…Ø¹Ø±ÙÙŠ
     */
    public getItem(itemId: string): KnowledgeItem | null {
        return this.items.get(itemId) || null;
    }
    
    /**
     * Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ø¹Ø±ÙÙŠ
     */
    public removeItem(itemId: string): boolean {
        let item = this.items.get(itemId);
        if (!item) return false;
        
        // Ø­Ø°Ù Ù…Ù† Ø§Ù„ÙÙ‡Ø§Ø±Ø³
        this.removeFromIndexes(item);
        
        // Ø­Ø°Ù Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        this.removeRelatedRelations(itemId);
        
        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
        for (let [clusterId, cluster] of this.clusters) {
            cluster.removeItem(itemId);
        }
        
        // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±
        this.items.delete(itemId);
        
        console.log(`   ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¹Ù†ØµØ±: ${item.title}`);
        return true;
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙÙ‡Ø§Ø±Ø³
     */
    private removeFromIndexes(item: KnowledgeItem): void {
        // ÙÙ‡Ø±Ø³ Ø§Ù„ÙØ¦Ø©
        let categorySet = this.itemsByCategory.get(item.category);
        if (categorySet) {
            categorySet.delete(item.itemId);
        }
        
        // ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        let levelSet = this.itemsByLevel.get(item.level);
        if (levelSet) {
            levelSet.delete(item.itemId);
        }
        
        // ÙÙ‡Ø±Ø³ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
        for (let tag of item.tags) {
            let tagSet = this.itemsByTag.get(tag);
            if (tagSet) {
                tagSet.delete(item.itemId);
            }
        }
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù‚Ø©
     */
    public addRelation(relation: KnowledgeRelation): string {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        if (!this.items.has(relation.sourceItemId) || !this.items.has(relation.targetItemId)) {
            throw new Error("Ø£Ø­Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
        
        this.relations.set(relation.relationId, relation);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        let sourceItem = this.items.get(relation.sourceItemId);
        let targetItem = this.items.get(relation.targetItemId);
        
        if (sourceItem) {
            sourceItem.linkRelatedItem(relation.targetItemId);
        }
        
        if (targetItem && relation.bidirectional) {
            targetItem.linkRelatedItem(relation.sourceItemId);
        }
        
        return relation.relationId;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ù†ØµØ±
     */
    public getItemRelations(itemId: string): array<KnowledgeRelation> {
        let itemRelations: array<KnowledgeRelation> = [];
        
        for (let [relationId, relation] of this.relations) {
            if (relation.sourceItemId === itemId || 
                (relation.bidirectional && relation.targetItemId === itemId)) {
                itemRelations.push(relation);
            }
        }
        
        return itemRelations;
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù†ØµØ±
     */
    private removeRelatedRelations(itemId: string): void {
        let relationsToRemove: array<string> = [];
        
        for (let [relationId, relation] of this.relations) {
            if (relation.sourceItemId === itemId || relation.targetItemId === itemId) {
                relationsToRemove.push(relationId);
            }
        }
        
        for (let relationId of relationsToRemove) {
            this.relations.delete(relationId);
        }
    }
    
    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹Ø±ÙÙŠØ©
     */
    public createCluster(name: string, category: KnowledgeCategory): string {
        let cluster = new KnowledgeCluster(name, category);
        this.clusters.set(cluster.clusterId, cluster);
        
        console.log(`   ğŸ“¦ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©: ${name}`);
        return cluster.clusterId;
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
     */
    public addItemToCluster(itemId: string, clusterId: string): boolean {
        let cluster = this.clusters.get(clusterId);
        if (!cluster || !this.items.has(itemId)) {
            return false;
        }

        cluster.addItem(itemId);
        return true;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…Ø¬Ù…ÙˆØ¹Ø©
     */
    public getClusterItems(clusterId: string): array<KnowledgeItem> {
        let cluster = this.clusters.get(clusterId);
        if (!cluster) return [];

        let items: array<KnowledgeItem> = [];
        for (let itemId of cluster.itemIds) {
            let item = this.items.get(itemId);
            if (item) items.push(item);
        }

        return items;
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
     */
    public search(query: string): array<KnowledgeItem> {
        let results: array<KnowledgeItem> = [];
        let queryLower = query.toLowerCase();

        for (let [itemId, item] of this.items) {
            if (item.title.toLowerCase().includes(queryLower) ||
                item.content.toLowerCase().includes(queryLower) ||
                item.tags.some(tag => tag.toLowerCase().includes(queryLower))) {
                results.push(item);
            }
        }

        return results;
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
     */
    public searchByCategory(category: KnowledgeCategory): array<KnowledgeItem> {
        let items: array<KnowledgeItem> = [];
        let itemIds = this.itemsByCategory.get(category);

        if (itemIds) {
            for (let itemId of itemIds) {
                let item = this.items.get(itemId);
                if (item) items.push(item);
            }
        }

        return items;
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
     */
    public searchByLevel(level: KnowledgeLevel): array<KnowledgeItem> {
        let items: array<KnowledgeItem> = [];
        let itemIds = this.itemsByLevel.get(level);

        if (itemIds) {
            for (let itemId of itemIds) {
                let item = this.items.get(itemId);
                if (item) items.push(item);
            }
        }

        return items;
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
     */
    public searchByTag(tag: string): array<KnowledgeItem> {
        let items: array<KnowledgeItem> = [];
        let itemIds = this.itemsByTag.get(tag);

        if (itemIds) {
            for (let itemId of itemIds) {
                let item = this.items.get(itemId);
                if (item) items.push(item);
            }
        }

        return items;
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
     */
    public advancedSearch(criteria: {
        query?: string,
        category?: KnowledgeCategory,
        level?: KnowledgeLevel,
        tags?: array<string>,
        minConfidence?: number
    }): array<KnowledgeItem> {
        let results: array<KnowledgeItem> = [];

        for (let [itemId, item] of this.items) {
            let matches = true;

            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ
            if (criteria.query) {
                let queryLower = criteria.query.toLowerCase();
                if (!item.title.toLowerCase().includes(queryLower) &&
                    !item.content.toLowerCase().includes(queryLower)) {
                    matches = false;
                }
            }

            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
            if (criteria.category && item.category !== criteria.category) {
                matches = false;
            }

            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
            if (criteria.level && item.level !== criteria.level) {
                matches = false;
            }

            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
            if (criteria.tags && criteria.tags.length > 0) {
                let hasTag = criteria.tags.some(tag => item.tags.includes(tag));
                if (!hasTag) matches = false;
            }

            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø«Ù‚Ø©
            if (criteria.minConfidence && item.confidence < criteria.minConfidence) {
                matches = false;
            }

            if (matches) {
                results.push(item);
            }
        }

        return results;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
     */
    public getRelatedItems(itemId: string, maxDepth: number = 1): array<KnowledgeItem> {
        let relatedItems: array<KnowledgeItem> = [];
        let visited = new Set<string>();

        this.findRelatedItems(itemId, maxDepth, 0, visited, relatedItems);

        return relatedItems;
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
     */
    private findRelatedItems(
        itemId: string,
        maxDepth: number,
        currentDepth: number,
        visited: Set<string>,
        results: array<KnowledgeItem>
    ): void {
        if (currentDepth >= maxDepth || visited.has(itemId)) {
            return;
        }

        visited.add(itemId);

        let relations = this.getItemRelations(itemId);
        for (let relation of relations) {
            let relatedId = relation.sourceItemId === itemId
                ? relation.targetItemId
                : relation.sourceItemId;

            if (!visited.has(relatedId)) {
                let relatedItem = this.items.get(relatedId);
                if (relatedItem) {
                    results.push(relatedItem);
                    this.findRelatedItems(relatedId, maxDepth, currentDepth + 1, visited, results);
                }
            }
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    public getStatistics(): object {
        let categoryCounts: any = {};
        let levelCounts: any = {};
        let tagCounts: any = {};

        for (let [itemId, item] of this.items) {
            // Ø¹Ø¯ Ø§Ù„ÙØ¦Ø§Øª
            categoryCounts[item.category] = (categoryCounts[item.category] || 0) + 1;

            // Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
            levelCounts[item.level] = (levelCounts[item.level] || 0) + 1;

            // Ø¹Ø¯ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
            for (let tag of item.tags) {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            }
        }

        return {
            totalItems: this.items.size,
            totalRelations: this.relations.size,
            totalClusters: this.clusters.size,
            categoryCounts: categoryCounts,
            levelCounts: levelCounts,
            topTags: Object.entries(tagCounts)
                .sort((a: any, b: any) => b[1] - a[1])
                .slice(0, 10)
                .map((entry: any) => ({tag: entry[0], count: entry[1]})),
            creationTime: this.creationTime
        };
    }

    /**
     * ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
     */
    public exportToJSON(): string {
        let data = {
            items: Array.from(this.items.values()),
            relations: Array.from(this.relations.values()),
            clusters: Array.from(this.clusters.values()).map(cluster => ({
                ...cluster,
                itemIds: Array.from(cluster.itemIds)
            })),
            statistics: this.getStatistics()
        };

        return JSON.stringify(data, null, 2);
    }

    /**
     * Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
     */
    public clear(): void {
        this.items.clear();
        this.relations.clear();
        this.clusters.clear();
        this.itemsByCategory.clear();
        this.itemsByLevel.clear();
        this.itemsByTag.clear();

        this.initializeIndexes();

        console.log("ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©");
    }
}

// ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ¦Ø§Øª
export {
    KnowledgeBase,
    KnowledgeRelation,
    KnowledgeCluster,
    RelationType
};
