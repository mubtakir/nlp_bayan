/**
 * Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ - Knowledge Integration System
 * 
 * ğŸ”— Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ù…ÙƒÙˆÙ†Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø±ÙØ©
 * ğŸ§  ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±ÙØ©
 * ğŸ”„ ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ·Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙÙƒÙŠØ±
 * 
 * @author Ø¨Ø§Ø³Ù„ ÙŠØ­ÙŠÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡
 * @version 1.0.0
 * @date 2025-10-27
 */

import { KnowledgeBase, KnowledgeRelation, KnowledgeCluster, RelationType } from "./knowledge-base.bn";
import { KnowledgeFeedingSystem, KnowledgeItem, KnowledgeCategory, KnowledgeLevel, FileType, DataSource } from "./knowledge-feeding-system.bn";
import { KnowledgeQueryEngine, QueryResult, QueryType, SortMethod } from "./knowledge-query-engine.bn";

/**
 * ÙØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ - IntegratedKnowledgeSystem
 */
class IntegratedKnowledgeSystem {
    private knowledgeBase: KnowledgeBase;
    private feedingSystem: KnowledgeFeedingSystem;
    private queryEngine: KnowledgeQueryEngine;
    private creationTime: Date;
    private lastUpdate: Date;
    
    /**
     * Ø§Ù„Ù…ÙÙ†Ø´Ø¦
     */
    constructor(knowledgeBasePath: string = "knowledge_base") {
        console.log("\nğŸ§ ğŸ“š ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ...");
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        this.knowledgeBase = new KnowledgeBase();
        this.feedingSystem = new KnowledgeFeedingSystem(knowledgeBasePath);
        this.queryEngine = new KnowledgeQueryEngine(this.knowledgeBase);
        
        this.creationTime = new Date();
        this.lastUpdate = new Date();
        
        console.log("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­!");
        console.log(`   ğŸ“… ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${this.creationTime.toLocaleString('ar-SA')}`);
    }
    
    // ==================== ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© ====================
    
    /**
     * ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† Ù…Ù„Ù
     */
    public feedFromFile(
        filePath: string,
        fileContent: string,
        category: KnowledgeCategory = KnowledgeCategory.GENERAL,
        metadata: object = {}
    ): object {
        console.log(`\nğŸ“¥ ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† Ù…Ù„Ù: ${filePath}`);
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù
        let result = this.feedingSystem.processFile(filePath, fileContent, category, metadata);
        
        if (result.success) {
            // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
            let items = this.feedingSystem.search("", category);
            
            for (let item of items) {
                this.knowledgeBase.addItem(item);
            }
            
            this.lastUpdate = new Date();
            
            console.log(`âœ… ØªÙ… ØªØºØ°ÙŠØ© ${result.itemsSaved} Ø¹Ù†ØµØ± Ù…Ø¹Ø±ÙÙŠ`);
        } else {
            console.log(`âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØºØ°ÙŠØ©: ${result.errors.join(', ')}`);
        }
        
        return {
            success: result.success,
            filePath: result.filePath,
            itemsAdded: result.itemsSaved,
            errors: result.errors
        };
    }
    
    /**
     * ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† Ù†Øµ
     */
    public feedFromText(
        title: string,
        content: string,
        category: KnowledgeCategory = KnowledgeCategory.GENERAL,
        level: KnowledgeLevel = KnowledgeLevel.BASIC
    ): string {
        console.log(`\nğŸ“ ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† Ù†Øµ: ${title}`);
        
        let item = new KnowledgeItem(title, content, category, level);
        item.sourceType = DataSource.MANUAL_INPUT;
        
        let itemId = this.knowledgeBase.addItem(item);
        this.lastUpdate = new Date();
        
        console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù…Ø¹Ø±ÙÙŠ: ${itemId}`);
        
        return itemId;
    }
    
    /**
     * ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† ÙƒØ§Ø¦Ù† JSON
     */
    public feedFromJSON(
        data: object,
        category: KnowledgeCategory = KnowledgeCategory.GENERAL
    ): number {
        console.log(`\nğŸ“Š ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† JSON`);
        
        let jsonString = JSON.stringify(data);
        let result = this.feedingSystem.processFile(
            "data.json",
            jsonString,
            category,
            {}
        );
        
        if (result.success) {
            let items = this.feedingSystem.search("", category);
            
            for (let item of items) {
                this.knowledgeBase.addItem(item);
            }
            
            this.lastUpdate = new Date();
            
            console.log(`âœ… ØªÙ… ØªØºØ°ÙŠØ© ${result.itemsSaved} Ø¹Ù†ØµØ± Ù…Ø¹Ø±ÙÙŠ`);
            return result.itemsSaved;
        }
        
        return 0;
    }
    
    // ==================== Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ§Ù„Ø¨Ø­Ø« ====================
    
    /**
     * Ø¨Ø­Ø« Ø¨Ø³ÙŠØ·
     */
    public search(query: string, maxResults: number = 10): array<QueryResult> {
        console.log(`\nğŸ” Ø¨Ø­Ø«: "${query}"`);
        
        let results = this.queryEngine.simpleQuery(query, maxResults);
        
        console.log(`   ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${results.length}`);
        
        return results;
    }
    
    /**
     * Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ
     */
    public semanticSearch(query: string, maxResults: number = 10): array<QueryResult> {
        console.log(`\nğŸ§  Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ: "${query}"`);
        
        let results = this.queryEngine.semanticQuery(query, maxResults);
        
        console.log(`   ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${results.length}`);
        
        return results;
    }
    
    /**
     * Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…
     */
    public advancedSearch(criteria: {
        query?: string,
        category?: KnowledgeCategory,
        level?: KnowledgeLevel,
        tags?: array<string>,
        minConfidence?: number,
        sortBy?: SortMethod,
        maxResults?: number
    }): array<QueryResult> {
        console.log(`\nğŸ”¬ Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…`);
        
        let results = this.queryEngine.advancedQuery(criteria);
        
        console.log(`   ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${results.length}`);
        
        return results;
    }
    
    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
     */
    public searchByCategory(category: KnowledgeCategory, maxResults: number = 10): array<QueryResult> {
        return this.queryEngine.queryByCategory(category, maxResults);
    }
    
    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
     */
    public searchByTag(tag: string, maxResults: number = 10): array<QueryResult> {
        return this.queryEngine.queryByTag(tag, maxResults);
    }
    
    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØºØ§Ù…Ø¶
     */
    public fuzzySearch(query: string, maxResults: number = 10, threshold: number = 0.6): array<QueryResult> {
        return this.queryEngine.fuzzyQuery(query, maxResults, threshold);
    }
    
    // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ====================
    
    /**
     * Ø±Ø¨Ø· Ø¹Ù†ØµØ±ÙŠÙ† Ù…Ø¹Ø±ÙÙŠÙŠÙ†
     */
    public linkItems(
        sourceItemId: string,
        targetItemId: string,
        relationType: RelationType,
        strength: number = 1.0,
        bidirectional: boolean = false
    ): string {
        console.log(`\nğŸ”— Ø±Ø¨Ø· Ø¹Ù†Ø§ØµØ±: ${sourceItemId} -> ${targetItemId}`);
        
        let relation = new KnowledgeRelation(sourceItemId, targetItemId, relationType, strength);
        relation.bidirectional = bidirectional;
        
        let relationId = this.knowledgeBase.addRelation(relation);
        this.lastUpdate = new Date();
        
        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù‚Ø©: ${relationId}`);
        
        return relationId;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
     */
    public getRelatedItems(itemId: string, maxDepth: number = 1): array<KnowledgeItem> {
        return this.knowledgeBase.getRelatedItems(itemId, maxDepth);
    }
    
    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ø§Ø¦Ù‚ÙŠ
     */
    public relationalSearch(itemId: string, relationType: RelationType | null = null, maxDepth: number = 2): array<QueryResult> {
        return this.queryEngine.relationalQuery(itemId, relationType, maxDepth);
    }
    
    // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ====================
    
    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹Ø±ÙÙŠØ©
     */
    public createCluster(name: string, category: KnowledgeCategory): string {
        let clusterId = this.knowledgeBase.createCluster(name, category);
        this.lastUpdate = new Date();
        return clusterId;
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
     */
    public addToCluster(itemId: string, clusterId: string): boolean {
        let success = this.knowledgeBase.addItemToCluster(itemId, clusterId);
        if (success) {
            this.lastUpdate = new Date();
        }
        return success;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…Ø¬Ù…ÙˆØ¹Ø©
     */
    public getClusterItems(clusterId: string): array<KnowledgeItem> {
        return this.knowledgeBase.getClusterItems(clusterId);
    }
    
    // ==================== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ====================
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©
     */
    public getStatistics(): object {
        let kbStats = this.knowledgeBase.getStatistics();
        let feedingStats = this.feedingSystem.getStatistics();
        let queryStats = this.queryEngine.getStatistics();
        
        return {
            knowledgeBase: kbStats,
            feeding: feedingStats,
            queries: queryStats,
            system: {
                creationTime: this.creationTime,
                lastUpdate: this.lastUpdate,
                uptime: Date.now() - this.creationTime.getTime()
            }
        };
    }
    
    /**
     * ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
     */
    public exportKnowledgeBase(): string {
        return this.knowledgeBase.exportToJSON();
    }
    
    /**
     * Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     */
    public clearAll(): void {
        this.knowledgeBase.clear();
        this.feedingSystem.clearAll();
        this.queryEngine.clearHistory();
        
        console.log("ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }
}

// ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ¦Ø©
export { IntegratedKnowledgeSystem };
