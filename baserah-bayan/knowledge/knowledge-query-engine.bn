/**
 * Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ© - Knowledge Query Engine
 * 
 * ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©
 * ğŸ§  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø¨Ø­Ø«
 * ğŸ“Š ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø©
 * 
 * @author Ø¨Ø§Ø³Ù„ ÙŠØ­ÙŠÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡
 * @version 1.0.0
 * @date 2025-10-27
 */

import { KnowledgeBase, KnowledgeRelation, RelationType } from "./knowledge-base.bn";
import { KnowledgeItem, KnowledgeCategory, KnowledgeLevel } from "./knowledge-feeding-system.bn";

/**
 * Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
 */
enum QueryType {
    SIMPLE = "simple",              // Ø¨Ø­Ø« Ø¨Ø³ÙŠØ·
    SEMANTIC = "semantic",          // Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ
    RELATIONAL = "relational",      // Ø¨Ø­Ø« Ø¹Ù„Ø§Ø¦Ù‚ÙŠ
    FUZZY = "fuzzy",                // Ø¨Ø­Ø« ØºØ§Ù…Ø¶
    ADVANCED = "advanced"           // Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…
}

/**
 * Ø·Ø±Ù‚ Ø§Ù„ØªØ±ØªÙŠØ¨
 */
enum SortMethod {
    RELEVANCE = "relevance",        // Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø©
    DATE = "date",                  // Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    CONFIDENCE = "confidence",      // Ø­Ø³Ø¨ Ø§Ù„Ø«Ù‚Ø©
    LEVEL = "level",                // Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
    ALPHABETICAL = "alphabetical"   // Ø£Ø¨Ø¬Ø¯ÙŠ
}

/**
 * ÙØ¦Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… - QueryResult
 */
class QueryResult {
    public item: KnowledgeItem;
    public relevanceScore: number;  // 0.0 - 1.0
    public matchedFields: array<string>;
    public snippet: string;
    
    constructor(item: KnowledgeItem, relevanceScore: number = 0.0) {
        this.item = item;
        this.relevanceScore = relevanceScore;
        this.matchedFields = [];
        this.snippet = "";
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ù…ØªØ·Ø§Ø¨Ù‚
     */
    public addMatchedField(field: string): void {
        if (!this.matchedFields.includes(field)) {
            this.matchedFields.push(field);
        }
    }
    
    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‚ØªØ·Ù
     */
    public createSnippet(query: string, maxLength: number = 150): void {
        let content = this.item.content;
        let queryLower = query.toLowerCase();
        let contentLower = content.toLowerCase();
        
        let index = contentLower.indexOf(queryLower);
        
        if (index !== -1) {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù‚ØªØ·Ù Ø­ÙˆÙ„ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
            let start = Math.max(0, index - 50);
            let end = Math.min(content.length, index + query.length + 100);
            
            this.snippet = (start > 0 ? "..." : "") + 
                          content.substring(start, end) + 
                          (end < content.length ? "..." : "");
        } else {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            this.snippet = content.substring(0, maxLength) + 
                          (content.length > maxLength ? "..." : "");
        }
    }
}

/**
 * ÙØ¦Ø© Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… - KnowledgeQueryEngine
 */
class KnowledgeQueryEngine {
    private knowledgeBase: KnowledgeBase;
    private queryHistory: array<object>;
    private totalQueries: number;
    
    /**
     * Ø§Ù„Ù…ÙÙ†Ø´Ø¦
     */
    constructor(knowledgeBase: KnowledgeBase) {
        this.knowledgeBase = knowledgeBase;
        this.queryHistory = [];
        this.totalQueries = 0;
        
        console.log("ğŸ” ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…");
    }
    
    /**
     * Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø³ÙŠØ·
     */
    public simpleQuery(
        query: string,
        maxResults: number = 10
    ): array<QueryResult> {
        this.totalQueries++;
        
        let items = this.knowledgeBase.search(query);
        let results: array<QueryResult> = [];
        
        for (let item of items) {
            let result = new QueryResult(item);
            result.relevanceScore = this.calculateSimpleRelevance(item, query);
            result.createSnippet(query);
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø©
            if (item.title.toLowerCase().includes(query.toLowerCase())) {
                result.addMatchedField("title");
            }
            if (item.content.toLowerCase().includes(query.toLowerCase())) {
                result.addMatchedField("content");
            }
            if (item.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))) {
                result.addMatchedField("tags");
            }
            
            results.push(result);
        }
        
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø©
        results.sort((a, b) => b.relevanceScore - a.relevanceScore);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
        this.logQuery(query, QueryType.SIMPLE, results.length);
        
        return results.slice(0, maxResults);
    }
    
    /**
     * Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙ„Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
     */
    private calculateSimpleRelevance(item: KnowledgeItem, query: string): number {
        let score = 0.0;
        let queryLower = query.toLowerCase();
        
        // ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ÙˆØ²Ù† 40%)
        if (item.title.toLowerCase().includes(queryLower)) {
            score += 0.4;
            
            // Ù…ÙƒØ§ÙØ£Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„
            if (item.title.toLowerCase() === queryLower) {
                score += 0.2;
            }
        }
        
        // ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ÙˆØ²Ù† 30%)
        if (item.content.toLowerCase().includes(queryLower)) {
            score += 0.3;
            
            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
            let matches = item.content.toLowerCase().split(queryLower).length - 1;
            score += Math.min(0.1, matches * 0.02);
        }
        
        // ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª (ÙˆØ²Ù† 20%)
        for (let tag of item.tags) {
            if (tag.toLowerCase().includes(queryLower)) {
                score += 0.2;
                break;
            }
        }
        
        // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø«Ù‚Ø© (ÙˆØ²Ù† 10%)
        score += item.confidence * 0.1;
        
        return Math.min(1.0, score);
    }
    
    /**
     * Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¯Ù„Ø§Ù„ÙŠ (Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¹Ù†Ù‰)
     */
    public semanticQuery(
        query: string,
        maxResults: number = 10
    ): array<QueryResult> {
        this.totalQueries++;
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
        let keywords = this.extractKeywords(query);
        
        let allResults: Map<string, QueryResult> = new Map();
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©
        for (let keyword of keywords) {
            let items = this.knowledgeBase.search(keyword);
            
            for (let item of items) {
                if (allResults.has(item.itemId)) {
                    // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµÙ„Ø© Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
                    let existing = allResults.get(item.itemId)!;
                    existing.relevanceScore += 0.1;
                } else {
                    let result = new QueryResult(item);
                    result.relevanceScore = this.calculateSemanticRelevance(item, keywords);
                    result.createSnippet(query);
                    allResults.set(item.itemId, result);
                }
            }
        }
        
        let results = Array.from(allResults.values());
        results.sort((a, b) => b.relevanceScore - a.relevanceScore);
        
        this.logQuery(query, QueryType.SEMANTIC, results.length);
        
        return results.slice(0, maxResults);
    }
    
    /**
     * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
     */
    private extractKeywords(query: string): array<string> {
        // ÙƒÙ„Ù…Ø§Øª ØªÙˆÙ‚Ù Ø¹Ø±Ø¨ÙŠØ© Ø´Ø§Ø¦Ø¹Ø©
        let stopWords = ['ÙÙŠ', 'Ù…Ù†', 'Ø¥Ù„Ù‰', 'Ø¹Ù„Ù‰', 'Ø¹Ù†', 'Ù‡Ùˆ', 'Ù‡ÙŠ', 'Ù…Ø§', 'Ù‡Ø°Ø§', 'Ù‡Ø°Ù‡', 'Ø°Ù„Ùƒ', 'ØªÙ„Ùƒ'];
        
        let words = query.toLowerCase().split(/\s+/);
        let keywords: array<string> = [];
        
        for (let word of words) {
            word = word.trim();
            if (word.length > 2 && !stopWords.includes(word)) {
                keywords.push(word);
            }
        }
        
        return keywords;
    }
    
    /**
     * Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙ„Ø© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©
     */
    private calculateSemanticRelevance(item: KnowledgeItem, keywords: array<string>): number {
        let score = 0.0;
        let matchCount = 0;
        
        for (let keyword of keywords) {
            let keywordLower = keyword.toLowerCase();
            
            if (item.title.toLowerCase().includes(keywordLower)) {
                score += 0.3;
                matchCount++;
            }
            
            if (item.content.toLowerCase().includes(keywordLower)) {
                score += 0.2;
                matchCount++;
            }
            
            for (let tag of item.tags) {
                if (tag.toLowerCase().includes(keywordLower)) {
                    score += 0.15;
                    matchCount++;
                    break;
                }
            }
        }
        
        // Ù…ÙƒØ§ÙØ£Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø¹Ø¯Ø© ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ©
        if (matchCount > 1) {
            score += matchCount * 0.05;
        }
        
        return Math.min(1.0, score);
    }
    
    /**
     * Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù„Ø§Ø¦Ù‚ÙŠ (Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª)
     */
    public relationalQuery(
        itemId: string,
        relationType: RelationType | null = null,
        maxDepth: number = 2
    ): array<QueryResult> {
        this.totalQueries++;
        
        let relatedItems = this.knowledgeBase.getRelatedItems(itemId, maxDepth);
        let results: array<QueryResult> = [];
        
        for (let item of relatedItems) {
            let result = new QueryResult(item);
            result.relevanceScore = 0.8;  // ØµÙ„Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
            results.push(result);
        }
        
        this.logQuery(`relational:${itemId}`, QueryType.RELATIONAL, results.length);
        
        return results;
    }
    
    /**
     * Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…ØªÙ‚Ø¯Ù…
     */
    public advancedQuery(criteria: {
        query?: string,
        category?: KnowledgeCategory,
        level?: KnowledgeLevel,
        tags?: array<string>,
        minConfidence?: number,
        sortBy?: SortMethod,
        maxResults?: number
    }): array<QueryResult> {
        this.totalQueries++;

        let items = this.knowledgeBase.advancedSearch(criteria);
        let results: array<QueryResult> = [];

        for (let item of items) {
            let result = new QueryResult(item);

            if (criteria.query) {
                result.relevanceScore = this.calculateSimpleRelevance(item, criteria.query);
                result.createSnippet(criteria.query);
            } else {
                result.relevanceScore = item.confidence;
            }

            results.push(result);
        }

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        this.sortResults(results, criteria.sortBy || SortMethod.RELEVANCE);

        this.logQuery(JSON.stringify(criteria), QueryType.ADVANCED, results.length);

        let maxResults = criteria.maxResults || 10;
        return results.slice(0, maxResults);
    }

    /**
     * ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
     */
    private sortResults(results: array<QueryResult>, sortMethod: SortMethod): void {
        if (sortMethod === SortMethod.RELEVANCE) {
            results.sort((a, b) => b.relevanceScore - a.relevanceScore);
        } else if (sortMethod === SortMethod.DATE) {
            results.sort((a, b) =>
                b.item.creationTime.getTime() - a.item.creationTime.getTime()
            );
        } else if (sortMethod === SortMethod.CONFIDENCE) {
            results.sort((a, b) => b.item.confidence - a.item.confidence);
        } else if (sortMethod === SortMethod.LEVEL) {
            let levelOrder = {
                [KnowledgeLevel.BASIC]: 1,
                [KnowledgeLevel.INTERMEDIATE]: 2,
                [KnowledgeLevel.ADVANCED]: 3,
                [KnowledgeLevel.EXPERT]: 4
            };
            results.sort((a, b) => levelOrder[b.item.level] - levelOrder[a.item.level]);
        } else if (sortMethod === SortMethod.ALPHABETICAL) {
            results.sort((a, b) => a.item.title.localeCompare(b.item.title));
        }
    }

    /**
     * Ø¨Ø­Ø« ØºØ§Ù…Ø¶ (Fuzzy Search)
     */
    public fuzzyQuery(
        query: string,
        maxResults: number = 10,
        threshold: number = 0.6
    ): array<QueryResult> {
        this.totalQueries++;

        let allItems = this.knowledgeBase.search("");  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        let results: array<QueryResult> = [];

        for (let item of allItems) {
            let similarity = this.calculateFuzzySimilarity(query, item.title);

            if (similarity >= threshold) {
                let result = new QueryResult(item);
                result.relevanceScore = similarity;
                result.createSnippet(query);
                results.push(result);
            }
        }

        results.sort((a, b) => b.relevanceScore - a.relevanceScore);

        this.logQuery(query, QueryType.FUZZY, results.length);

        return results.slice(0, maxResults);
    }

    /**
     * Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø§Ù„ØºØ§Ù…Ø¶ (Levenshtein Distance)
     */
    private calculateFuzzySimilarity(str1: string, str2: string): number {
        let s1 = str1.toLowerCase();
        let s2 = str2.toLowerCase();

        let len1 = s1.length;
        let len2 = s2.length;

        if (len1 === 0) return len2 === 0 ? 1.0 : 0.0;
        if (len2 === 0) return 0.0;

        // Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
        let matrix: array<array<number>> = [];

        for (let i = 0; i <= len1; i++) {
            matrix[i] = [];
            matrix[i][0] = i;
        }

        for (let j = 0; j <= len2; j++) {
            matrix[0][j] = j;
        }

        for (let i = 1; i <= len1; i++) {
            for (let j = 1; j <= len2; j++) {
                let cost = s1[i - 1] === s2[j - 1] ? 0 : 1;

                matrix[i][j] = Math.min(
                    matrix[i - 1][j] + 1,      // Ø­Ø°Ù
                    matrix[i][j - 1] + 1,      // Ø¥Ø¶Ø§ÙØ©
                    matrix[i - 1][j - 1] + cost // Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                );
            }
        }

        let distance = matrix[len1][len2];
        let maxLen = Math.max(len1, len2);

        return 1.0 - (distance / maxLen);
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
     */
    public queryByCategory(
        category: KnowledgeCategory,
        maxResults: number = 10
    ): array<QueryResult> {
        let items = this.knowledgeBase.searchByCategory(category);
        let results: array<QueryResult> = [];

        for (let item of items) {
            let result = new QueryResult(item);
            result.relevanceScore = item.confidence;
            results.push(result);
        }

        results.sort((a, b) => b.relevanceScore - a.relevanceScore);

        return results.slice(0, maxResults);
    }

    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
     */
    public queryByTag(
        tag: string,
        maxResults: number = 10
    ): array<QueryResult> {
        let items = this.knowledgeBase.searchByTag(tag);
        let results: array<QueryResult> = [];

        for (let item of items) {
            let result = new QueryResult(item);
            result.relevanceScore = item.confidence;
            results.push(result);
        }

        results.sort((a, b) => b.relevanceScore - a.relevanceScore);

        return results.slice(0, maxResults);
    }

    /**
     * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
     */
    private logQuery(query: string, queryType: QueryType, resultCount: number): void {
        this.queryHistory.push({
            query: query,
            queryType: queryType,
            resultCount: resultCount,
            timestamp: new Date()
        });

        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 100 Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙÙ‚Ø·
        if (this.queryHistory.length > 100) {
            this.queryHistory.shift();
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    public getStatistics(): object {
        let queryTypeCounts: any = {};

        for (let entry of this.queryHistory) {
            let type = (entry as any).queryType;
            queryTypeCounts[type] = (queryTypeCounts[type] || 0) + 1;
        }

        return {
            totalQueries: this.totalQueries,
            recentQueries: this.queryHistory.length,
            queryTypeCounts: queryTypeCounts,
            averageResultsPerQuery: this.queryHistory.length > 0
                ? (this.queryHistory.reduce((sum, entry) => sum + (entry as any).resultCount, 0) / this.queryHistory.length).toFixed(2)
                : 0
        };
    }

    /**
     * Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
     */
    public clearHistory(): void {
        this.queryHistory = [];
        console.log("ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª");
    }
}

// ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ¦Ø§Øª
export {
    KnowledgeQueryEngine,
    QueryResult,
    QueryType,
    SortMethod
};
