/**
 * Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†ØµÙˆØµ - Text Generator
 * 
 * ÙŠÙˆÙ„Ø¯ Ù†ØµÙˆØµ Ø·Ø¨ÙŠØ¹ÙŠØ© Ù…Ù† Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * ÙŠØ³ØªØ®Ø¯Ù… Ù‚ÙˆØ§Ù„Ø¨ Ø°ÙƒÙŠØ© ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ù„ØºÙˆÙŠØ©
 * ÙŠØªÙƒÙŠÙ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„Ø£Ø³Ù„ÙˆØ¨
 * 
 * @version 1.0.0
 * @author Baserah AI Team
 */

import { MotherEquation } from "../core/mother-equation.bn";
import { IntentType, DetectedIntent } from "./intent-analyzer.bn";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØ¹Ø¯Ø§Ø¯Ø§Øª - Enumerations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
 */
export enum ResponseType {
    ANSWER = "ANSWER",              // Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„
    ACKNOWLEDGMENT = "ACKNOWLEDGMENT", // Ø¥Ù‚Ø±Ø§Ø±/ØªØ£ÙƒÙŠØ¯
    INFORMATION = "INFORMATION",    // Ù…Ø¹Ù„ÙˆÙ…Ø©
    INSTRUCTION = "INSTRUCTION",    // ØªØ¹Ù„ÙŠÙ…Ø§Øª
    GREETING = "GREETING",          // ØªØ­ÙŠØ©
    FAREWELL = "FAREWELL",          // ÙˆØ¯Ø§Ø¹
    APOLOGY = "APOLOGY",            // Ø§Ø¹ØªØ°Ø§Ø±
    THANKS = "THANKS",              // Ø´ÙƒØ±
    CLARIFICATION = "CLARIFICATION", // ØªÙˆØ¶ÙŠØ­
    SUGGESTION = "SUGGESTION",      // Ø§Ù‚ØªØ±Ø§Ø­
    ERROR = "ERROR",                // Ø®Ø·Ø£
    UNKNOWN = "UNKNOWN"             // ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
}

/**
 * Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ÙƒØªØ§Ø¨Ø©
 */
export enum WritingStyle {
    FORMAL = "FORMAL",              // Ø±Ø³Ù…ÙŠ
    INFORMAL = "INFORMAL",          // ØºÙŠØ± Ø±Ø³Ù…ÙŠ
    FRIENDLY = "FRIENDLY",          // ÙˆØ¯ÙŠ
    PROFESSIONAL = "PROFESSIONAL",  // Ø§Ø­ØªØ±Ø§ÙÙŠ
    CASUAL = "CASUAL",              // Ø¹Ø§Ø¯ÙŠ
    TECHNICAL = "TECHNICAL",        // ØªÙ‚Ù†ÙŠ
    SIMPLE = "SIMPLE"               // Ø¨Ø³ÙŠØ·
}

/**
 * Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙØµÙŠÙ„
 */
export enum DetailLevel {
    MINIMAL = "MINIMAL",            // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
    BRIEF = "BRIEF",                // Ù…ÙˆØ¬Ø²
    MODERATE = "MODERATE",          // Ù…ØªÙˆØ³Ø·
    DETAILED = "DETAILED",          // Ù…ÙØµÙ„
    COMPREHENSIVE = "COMPREHENSIVE" // Ø´Ø§Ù…Ù„
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ÙØ¦Ø§Øª - Classes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ù‚Ø§Ù„Ø¨ Ù†ØµÙŠ
 */
export class TextTemplate extends MotherEquation {
    name: string;
    pattern: string;
    variables: string[];
    examples: string[];
    usageCount: number;

    constructor(id: string, name: string, pattern: string) {
        super(id);
        this.name = name;
        this.pattern = pattern;
        this.variables = this.extractVariables(pattern);
        this.examples = [];
        this.usageCount = 0;
    }

    /**
     * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨
     */
    private extractVariables(pattern: string): string[] {
        let variables: string[] = [];
        let regex = /\{(\w+)\}/g;
        let match;

        while ((match = regex.exec(pattern)) !== null) {
            if (!variables.includes(match[1])) {
                variables.push(match[1]);
            }
        }

        return variables;
    }

    /**
     * Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ø§Ù„Ù‚ÙŠÙ…
     */
    fill(values: Map<string, string>): string {
        let result = this.pattern;

        for (let [key, value] of values) {
            let placeholder = `{${key}}`;
            result = result.replace(new RegExp(placeholder, "g"), value);
        }

        this.usageCount++;
        return result;
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø«Ø§Ù„
     */
    addExample(example: string): void {
        this.examples.push(example);
    }
}

/**
 * Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙ„ÙŠØ¯
 */
export class GenerationSettings extends MotherEquation {
    style: WritingStyle;
    detailLevel: DetailLevel;
    maxLength: number;
    includeEmojis: boolean;
    includePunctuation: boolean;
    usePoliteForm: boolean;

    constructor(id: string = "gen-settings-default") {
        super(id);
        this.style = WritingStyle.FRIENDLY;
        this.detailLevel = DetailLevel.MODERATE;
        this.maxLength = 500;
        this.includeEmojis = true;
        this.includePunctuation = true;
        this.usePoliteForm = true;
    }
}

/**
 * Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯
 */
export class GenerationResult extends MotherEquation {
    generatedText: string;
    templateUsed: string | null;
    confidence: number;
    alternatives: string[];
    metadata: Map<string, any>;

    constructor(id: string, generatedText: string) {
        super(id);
        this.generatedText = generatedText;
        this.templateUsed = null;
        this.confidence = 1.0;
        this.alternatives = [];
        this.metadata = new Map();
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¨Ø¯ÙŠÙ„
     */
    addAlternative(text: string): void {
        this.alternatives.push(text);
    }
}

/**
 * Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†ØµÙˆØµ - Text Generator
 */
export class TextGenerator extends MotherEquation {
    // Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù†ØµÙŠØ©
    private templates: Map<ResponseType, TextTemplate[]>;
    
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    private defaultSettings: GenerationSettings;
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    private stats: {
        totalGenerations: number;
        templateUsage: Map<string, number>;
        averageLength: number;
    };

    constructor(id: string = "text-generator-001") {
        super(id);
        this.templates = new Map();
        this.defaultSettings = new GenerationSettings();
        this.stats = {
            totalGenerations: 0,
            templateUsage: new Map(),
            averageLength: 0
        };
        
        this.initializeTemplates();
    }

    /**
     * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù†ØµÙŠØ©
     */
    private initializeTemplates(): void {
        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        this.addTemplate(ResponseType.ANSWER, "answer-direct", "{answer}");
        this.addTemplate(ResponseType.ANSWER, "answer-polite", "Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯! {answer}");
        this.addTemplate(ResponseType.ANSWER, "answer-detailed", "Ø¯Ø¹Ù†ÙŠ Ø£ÙˆØ¶Ø­ Ù„Ùƒ: {answer}");
        this.addTemplate(ResponseType.ANSWER, "answer-simple", "Ø¨Ø¨Ø³Ø§Ø·Ø©ØŒ {answer}");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ØªØ­ÙŠØ©
        this.addTemplate(ResponseType.GREETING, "greeting-formal", "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡");
        this.addTemplate(ResponseType.GREETING, "greeting-friendly", "Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ");
        this.addTemplate(ResponseType.GREETING, "greeting-casual", "Ø£Ù‡Ù„Ø§Ù‹! ğŸ˜Š");
        this.addTemplate(ResponseType.GREETING, "greeting-professional", "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø®Ø¯Ù…ØªÙƒØŸ");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ÙˆØ¯Ø§Ø¹
        this.addTemplate(ResponseType.FAREWELL, "farewell-formal", "ÙÙŠ Ø£Ù…Ø§Ù† Ø§Ù„Ù„Ù‡");
        this.addTemplate(ResponseType.FAREWELL, "farewell-friendly", "ÙˆØ¯Ø§Ø¹Ø§Ù‹! ğŸ‘‹ ÙƒØ§Ù† Ù…Ù† Ø¯ÙˆØ§Ø¹ÙŠ Ø³Ø±ÙˆØ±ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ");
        this.addTemplate(ResponseType.FAREWELL, "farewell-casual", "Ø¨Ø§ÙŠ! ğŸ˜Š");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø´ÙƒØ±
        this.addTemplate(ResponseType.THANKS, "thanks-simple", "Ø§Ù„Ø¹ÙÙˆ! ğŸ˜Š");
        this.addTemplate(ResponseType.THANKS, "thanks-polite", "Ù„Ø§ Ø´ÙƒØ± Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ø¨ØŒ Ø³Ø¹ÙŠØ¯ Ø¨Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ");
        this.addTemplate(ResponseType.THANKS, "thanks-formal", "ØªÙØ¶Ù„ØŒ ÙÙŠ Ø®Ø¯Ù…ØªÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±
        this.addTemplate(ResponseType.APOLOGY, "apology-simple", "Ø¢Ø³Ù Ø¹Ù„Ù‰ Ø°Ù„Ùƒ");
        this.addTemplate(ResponseType.APOLOGY, "apology-sincere", "Ø£Ø¹ØªØ°Ø± Ø¨Ø´Ø¯Ø© Ø¹Ù† {reason}");
        this.addTemplate(ResponseType.APOLOGY, "apology-helpful", "Ø¢Ø³ÙØŒ Ø¯Ø¹Ù†ÙŠ Ø£Ø­Ø§ÙˆÙ„ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±
        this.addTemplate(ResponseType.ACKNOWLEDGMENT, "ack-simple", "ÙÙ‡Ù…Øª");
        this.addTemplate(ResponseType.ACKNOWLEDGMENT, "ack-polite", "ÙÙ‡Ù…Øª Ø·Ù„Ø¨ÙƒØŒ Ø³Ø£Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡");
        this.addTemplate(ResponseType.ACKNOWLEDGMENT, "ack-detailed", "ÙÙ‡Ù…Øª {topic}ØŒ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨Ù€ {action}");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        this.addTemplate(ResponseType.INFORMATION, "info-direct", "{information}");
        this.addTemplate(ResponseType.INFORMATION, "info-intro", "Ø¥Ù„ÙŠÙƒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: {information}");
        this.addTemplate(ResponseType.INFORMATION, "info-detailed", "Ø¨Ø®ØµÙˆØµ {topic}ØŒ {information}");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
        this.addTemplate(ResponseType.INSTRUCTION, "inst-simple", "{steps}");
        this.addTemplate(ResponseType.INSTRUCTION, "inst-numbered", "Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:\n{steps}");
        this.addTemplate(ResponseType.INSTRUCTION, "inst-detailed", "Ù„ØªØ­Ù‚ÙŠÙ‚ {goal}ØŒ Ø§ØªØ¨Ø¹:\n{steps}");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ØªÙˆØ¶ÙŠØ­
        this.addTemplate(ResponseType.CLARIFICATION, "clarify-question", "Ù‡Ù„ ØªÙ‚ØµØ¯ {option1} Ø£Ù… {option2}ØŸ");
        this.addTemplate(ResponseType.CLARIFICATION, "clarify-polite", "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ¶ÙŠØ­ {unclear_part}ØŸ");
        this.addTemplate(ResponseType.CLARIFICATION, "clarify-helpful", "Ù„Ù… Ø£ÙÙ‡Ù… ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ù‡Ù„ ØªÙ‚ØµØ¯ {interpretation}ØŸ");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­
        this.addTemplate(ResponseType.SUGGESTION, "suggest-simple", "Ø£Ù‚ØªØ±Ø­ {suggestion}");
        this.addTemplate(ResponseType.SUGGESTION, "suggest-polite", "Ù…Ø§Ø°Ø§ Ø¹Ù† {suggestion}ØŸ");
        this.addTemplate(ResponseType.SUGGESTION, "suggest-multiple", "Ù„Ø¯ÙŠÙƒ Ø¹Ø¯Ø© Ø®ÙŠØ§Ø±Ø§Øª:\n{options}");

        // Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø®Ø·Ø£
        this.addTemplate(ResponseType.ERROR, "error-simple", "Ø­Ø¯Ø« Ø®Ø·Ø£");
        this.addTemplate(ResponseType.ERROR, "error-helpful", "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {error}. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ");
        this.addTemplate(ResponseType.ERROR, "error-technical", "Ø®Ø·Ø£: {error_code} - {error_message}");
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ù„Ø¨
     */
    private addTemplate(type: ResponseType, name: string, pattern: string): void {
        if (!this.templates.has(type)) {
            this.templates.set(type, []);
        }

        let template = new TextTemplate(
            `template-${type}-${name}`,
            name,
            pattern
        );

        this.templates.get(type).push(template);
    }

    /**
     * ØªÙˆÙ„ÙŠØ¯ Ù†Øµ
     */
    generate(
        responseType: ResponseType,
        data: Map<string, string>,
        settings: GenerationSettings = null
    ): GenerationResult {
        if (!settings) {
            settings = this.defaultSettings;
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        let template = this.selectTemplate(responseType, settings);

        if (!template) {
            return new GenerationResult(
                `gen-result-${Date.now()}`,
                "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù†Ø§Ø³Ø¨Ø©"
            );
        }

        // Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ù„Ø¨
        let text = template.fill(data);

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
        text = this.applyEnhancements(text, settings);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        let result = new GenerationResult(`gen-result-${Date.now()}`, text);
        result.templateUsed = template.name;

        // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¯Ø§Ø¦Ù„
        let alternatives = this.generateAlternatives(responseType, data, settings, template);
        for (let alt of alternatives) {
            result.addAlternative(alt);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        this.updateStats(result);

        return result;
    }

    /**
     * Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
     */
    private selectTemplate(type: ResponseType, settings: GenerationSettings): TextTemplate | null {
        if (!this.templates.has(type)) {
            return null;
        }

        let templates = this.templates.get(type);
        
        if (templates.length === 0) {
            return null;
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨
        if (settings.style === WritingStyle.FORMAL) {
            for (let template of templates) {
                if (template.name.includes("formal")) {
                    return template;
                }
            }
        } else if (settings.style === WritingStyle.FRIENDLY) {
            for (let template of templates) {
                if (template.name.includes("friendly") || template.name.includes("polite")) {
                    return template;
                }
            }
        } else if (settings.style === WritingStyle.CASUAL) {
            for (let template of templates) {
                if (template.name.includes("casual") || template.name.includes("simple")) {
                    return template;
                }
            }
        }

        // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø£ÙˆÙ„ Ù‚Ø§Ù„Ø¨
        return templates[0];
    }

    /**
     * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
     */
    private applyEnhancements(text: string, settings: GenerationSettings): string {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        if (!settings.includeEmojis) {
            text = text.replace(/[\u{1F600}-\u{1F64F}]/gu, "");
            text = text.replace(/[\u{1F300}-\u{1F5FF}]/gu, "");
            text = text.replace(/[\u{1F680}-\u{1F6FF}]/gu, "");
            text = text.replace(/[\u{2600}-\u{26FF}]/gu, "");
        }

        // Ù‚Øµ Ø§Ù„Ù†Øµ Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
        if (text.length > settings.maxLength) {
            text = text.substring(0, settings.maxLength - 3) + "...";
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
        text = text.trim().replace(/\s+/g, " ");

        return text;
    }

    /**
     * ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¯Ø§Ø¦Ù„
     */
    private generateAlternatives(
        type: ResponseType,
        data: Map<string, string>,
        settings: GenerationSettings,
        excludeTemplate: TextTemplate
    ): string[] {
        let alternatives: string[] = [];

        if (!this.templates.has(type)) {
            return alternatives;
        }

        let templates = this.templates.get(type);

        for (let template of templates) {
            if (template.id === excludeTemplate.id) {
                continue;
            }

            let text = template.fill(data);
            text = this.applyEnhancements(text, settings);
            alternatives.push(text);

            // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 3 Ø¨Ø¯Ø§Ø¦Ù„
            if (alternatives.length >= 3) {
                break;
            }
        }

        return alternatives;
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    private updateStats(result: GenerationResult): void {
        this.stats.totalGenerations++;

        if (result.templateUsed) {
            let count = this.stats.templateUsage.get(result.templateUsed) || 0;
            this.stats.templateUsage.set(result.templateUsed, count + 1);
        }

        // ØªØ­Ø¯ÙŠØ« Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·ÙˆÙ„
        let totalLength = this.stats.averageLength * (this.stats.totalGenerations - 1);
        totalLength += result.generatedText.length;
        this.stats.averageLength = totalLength / this.stats.totalGenerations;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    getStats(): any {
        return {
            totalGenerations: this.stats.totalGenerations,
            averageLength: Math.round(this.stats.averageLength),
            templateUsage: Object.fromEntries(this.stats.templateUsage)
        };
    }
}

