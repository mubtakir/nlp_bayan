/**
 * Ù…Ø®Ø·Ø· Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© - Response Planner
 * 
 * ÙŠØ®Ø·Ø· Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙŠØ© Ø§Ù„Ù…ÙƒØªØ´ÙØ©
 * ÙŠØ­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
 * ÙŠØ¨Ù†ÙŠ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¯ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯
 * 
 * @version 1.0.0
 * @author Baserah AI Team
 */

import { MotherEquation } from "../core/mother-equation.bn";
import { IntentType, DetectedIntent, IntentAnalysisResult } from "./intent-analyzer.bn";
import { ResponseType } from "./text-generator.bn";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØ¹Ø¯Ø§Ø¯Ø§Øª - Enumerations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
 */
export enum ResponseStrategy {
    DIRECT = "DIRECT",              // Ù…Ø¨Ø§Ø´Ø±Ø©
    INFORMATIVE = "INFORMATIVE",    // Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ©
    INTERACTIVE = "INTERACTIVE",    // ØªÙØ§Ø¹Ù„ÙŠØ©
    EDUCATIONAL = "EDUCATIONAL",    // ØªØ¹Ù„ÙŠÙ…ÙŠØ©
    SUPPORTIVE = "SUPPORTIVE",      // Ø¯Ø§Ø¹Ù…Ø©
    CLARIFYING = "CLARIFYING"       // ØªÙˆØ¶ÙŠØ­ÙŠØ©
}

/**
 * Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
 */
export enum ResponsePriority {
    URGENT = "URGENT",              // Ø¹Ø§Ø¬Ù„
    HIGH = "HIGH",                  // Ø¹Ø§Ù„ÙŠ
    NORMAL = "NORMAL",              // Ø¹Ø§Ø¯ÙŠ
    LOW = "LOW"                     // Ù…Ù†Ø®ÙØ¶
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ÙØ¦Ø§Øª - Classes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ø¹Ù†ØµØ± ÙÙŠ Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
 */
export class ResponseComponent extends MotherEquation {
    type: string;
    content: Map<string, any>;
    order: number;
    isOptional: boolean;

    constructor(id: string, type: string, order: number) {
        super(id);
        this.type = type;
        this.content = new Map();
        this.order = order;
        this.isOptional = false;
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰
     */
    addContent(key: string, value: any): void {
        this.content.set(key, value);
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰
     */
    getContent(key: string): any {
        return this.content.get(key);
    }
}

/**
 * Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
 */
export class ResponsePlan extends MotherEquation {
    intentAnalysis: IntentAnalysisResult;
    responseType: ResponseType;
    strategy: ResponseStrategy;
    priority: ResponsePriority;
    components: ResponseComponent[];
    requiredData: Map<string, any>;
    metadata: Map<string, any>;

    constructor(id: string, intentAnalysis: IntentAnalysisResult) {
        super(id);
        this.intentAnalysis = intentAnalysis;
        this.responseType = ResponseType.UNKNOWN;
        this.strategy = ResponseStrategy.DIRECT;
        this.priority = ResponsePriority.NORMAL;
        this.components = [];
        this.requiredData = new Map();
        this.metadata = new Map();
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…ÙƒÙˆÙ†
     */
    addComponent(component: ResponseComponent): void {
        this.components.push(component);
        this.components.sort((a, b) => a.order - b.order);
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©
     */
    addRequiredData(key: string, value: any): void {
        this.requiredData.set(key, value);
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
     */
    getRequiredData(): Map<string, any> {
        return this.requiredData;
    }

    /**
     * ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±
     */
    generateReport(): string {
        let report = "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        report += "ğŸ“‹ Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©\n";
        report += "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

        report += `ğŸ¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${this.responseType}\n`;
        report += `ğŸ“Š Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: ${this.strategy}\n`;
        report += `âš¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${this.priority}\n\n`;

        if (this.components.length > 0) {
            report += `ğŸ§© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (${this.components.length}):\n`;
            for (let component of this.components) {
                let optional = component.isOptional ? " (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" : "";
                report += `   ${component.order}. ${component.type}${optional}\n`;
            }
        }

        if (this.requiredData.size > 0) {
            report += `\nğŸ“¦ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${this.requiredData.size}):\n`;
            for (let [key, value] of this.requiredData) {
                report += `   - ${key}: ${value}\n`;
            }
        }

        return report;
    }
}

/**
 * Ù…Ø®Ø·Ø· Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© - Response Planner
 */
export class ResponsePlanner extends MotherEquation {
    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†ÙˆØ§ÙŠØ§ Ø¥Ù„Ù‰ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    private intentToResponseMap: Map<IntentType, ResponseType>;
    
    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†ÙˆØ§ÙŠØ§ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª
    private intentToStrategyMap: Map<IntentType, ResponseStrategy>;
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    private stats: {
        totalPlans: number;
        strategyDistribution: Map<ResponseStrategy, number>;
        averageComponents: number;
    };

    constructor(id: string = "response-planner-001") {
        super(id);
        this.intentToResponseMap = new Map();
        this.intentToStrategyMap = new Map();
        this.stats = {
            totalPlans: 0,
            strategyDistribution: new Map(),
            averageComponents: 0
        };
        
        this.initializeMappings();
    }

    /**
     * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø·
     */
    private initializeMappings(): void {
        // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†ÙˆØ§ÙŠØ§ Ø¥Ù„Ù‰ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        this.intentToResponseMap.set(IntentType.QUESTION, ResponseType.ANSWER);
        this.intentToResponseMap.set(IntentType.REQUEST, ResponseType.ACKNOWLEDGMENT);
        this.intentToResponseMap.set(IntentType.COMMAND, ResponseType.ACKNOWLEDGMENT);
        this.intentToResponseMap.set(IntentType.GREETING, ResponseType.GREETING);
        this.intentToResponseMap.set(IntentType.FAREWELL, ResponseType.FAREWELL);
        this.intentToResponseMap.set(IntentType.THANKS, ResponseType.THANKS);
        this.intentToResponseMap.set(IntentType.APOLOGY, ResponseType.APOLOGY);
        this.intentToResponseMap.set(IntentType.CONFIRMATION, ResponseType.ACKNOWLEDGMENT);
        this.intentToResponseMap.set(IntentType.NEGATION, ResponseType.ACKNOWLEDGMENT);
        this.intentToResponseMap.set(IntentType.OPINION, ResponseType.ACKNOWLEDGMENT);
        this.intentToResponseMap.set(IntentType.EMOTION, ResponseType.ACKNOWLEDGMENT);
        this.intentToResponseMap.set(IntentType.SUGGESTION, ResponseType.SUGGESTION);
        this.intentToResponseMap.set(IntentType.COMPLAINT, ResponseType.APOLOGY);
        this.intentToResponseMap.set(IntentType.PRAISE, ResponseType.THANKS);
        this.intentToResponseMap.set(IntentType.CRITICISM, ResponseType.ACKNOWLEDGMENT);
        this.intentToResponseMap.set(IntentType.UNKNOWN, ResponseType.CLARIFICATION);

        // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†ÙˆØ§ÙŠØ§ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª
        this.intentToStrategyMap.set(IntentType.QUESTION, ResponseStrategy.INFORMATIVE);
        this.intentToStrategyMap.set(IntentType.REQUEST, ResponseStrategy.SUPPORTIVE);
        this.intentToStrategyMap.set(IntentType.COMMAND, ResponseStrategy.DIRECT);
        this.intentToStrategyMap.set(IntentType.GREETING, ResponseStrategy.INTERACTIVE);
        this.intentToStrategyMap.set(IntentType.FAREWELL, ResponseStrategy.INTERACTIVE);
        this.intentToStrategyMap.set(IntentType.THANKS, ResponseStrategy.INTERACTIVE);
        this.intentToStrategyMap.set(IntentType.APOLOGY, ResponseStrategy.SUPPORTIVE);
        this.intentToStrategyMap.set(IntentType.CONFIRMATION, ResponseStrategy.DIRECT);
        this.intentToStrategyMap.set(IntentType.NEGATION, ResponseStrategy.CLARIFYING);
        this.intentToStrategyMap.set(IntentType.OPINION, ResponseStrategy.INTERACTIVE);
        this.intentToStrategyMap.set(IntentType.EMOTION, ResponseStrategy.SUPPORTIVE);
        this.intentToStrategyMap.set(IntentType.SUGGESTION, ResponseStrategy.INTERACTIVE);
        this.intentToStrategyMap.set(IntentType.COMPLAINT, ResponseStrategy.SUPPORTIVE);
        this.intentToStrategyMap.set(IntentType.PRAISE, ResponseStrategy.INTERACTIVE);
        this.intentToStrategyMap.set(IntentType.CRITICISM, ResponseStrategy.SUPPORTIVE);
        this.intentToStrategyMap.set(IntentType.UNKNOWN, ResponseStrategy.CLARIFYING);
    }

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø©
     */
    createPlan(intentAnalysis: IntentAnalysisResult): ResponsePlan {
        let plan = new ResponsePlan(
            `response-plan-${Date.now()}`,
            intentAnalysis
        );

        // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        plan.responseType = this.determineResponseType(intentAnalysis);

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
        plan.strategy = this.determineStrategy(intentAnalysis);

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
        plan.priority = this.determinePriority(intentAnalysis);

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        this.buildComponents(plan);

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        this.identifyRequiredData(plan);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        this.updateStats(plan);

        return plan;
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
     */
    private determineResponseType(analysis: IntentAnalysisResult): ResponseType {
        if (!analysis.primaryIntent) {
            return ResponseType.UNKNOWN;
        }

        let intentType = analysis.primaryIntent.type;
        
        if (this.intentToResponseMap.has(intentType)) {
            return this.intentToResponseMap.get(intentType);
        }

        return ResponseType.UNKNOWN;
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
     */
    private determineStrategy(analysis: IntentAnalysisResult): ResponseStrategy {
        if (!analysis.primaryIntent) {
            return ResponseStrategy.CLARIFYING;
        }

        let intentType = analysis.primaryIntent.type;
        
        if (this.intentToStrategyMap.has(intentType)) {
            return this.intentToStrategyMap.get(intentType);
        }

        return ResponseStrategy.DIRECT;
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
     */
    private determinePriority(analysis: IntentAnalysisResult): ResponsePriority {
        if (!analysis.primaryIntent) {
            return ResponsePriority.NORMAL;
        }

        let intentType = analysis.primaryIntent.type;

        // Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù„Ù‡Ø§ Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©
        if (intentType === IntentType.COMMAND || intentType === IntentType.COMPLAINT) {
            return ResponsePriority.HIGH;
        }

        // Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø§ Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ø¯ÙŠØ©
        if (intentType === IntentType.QUESTION) {
            return ResponsePriority.NORMAL;
        }

        // Ø§Ù„ØªØ­ÙŠØ§Øª ÙˆØ§Ù„ÙˆØ¯Ø§Ø¹ Ù„Ù‡Ø§ Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©
        if (intentType === IntentType.GREETING || intentType === IntentType.FAREWELL) {
            return ResponsePriority.LOW;
        }

        return ResponsePriority.NORMAL;
    }

    /**
     * Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
     */
    private buildComponents(plan: ResponsePlan): void {
        let order = 1;

        // Ù…ÙƒÙˆÙ† Ø§Ù„ØªØ­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if (plan.strategy === ResponseStrategy.INTERACTIVE) {
            let greeting = new ResponseComponent(
                `component-greeting-${Date.now()}`,
                "greeting",
                order++
            );
            greeting.isOptional = true;
            plan.addComponent(greeting);
        }

        // Ù…ÙƒÙˆÙ† Ø§Ù„Ø¥Ù‚Ø±Ø§Ø±
        if (plan.responseType === ResponseType.ACKNOWLEDGMENT) {
            let ack = new ResponseComponent(
                `component-acknowledgment-${Date.now()}`,
                "acknowledgment",
                order++
            );
            plan.addComponent(ack);
        }

        // Ù…ÙƒÙˆÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        let mainContent = new ResponseComponent(
            `component-main-${Date.now()}`,
            "main_content",
            order++
        );
        plan.addComponent(mainContent);

        // Ù…ÙƒÙˆÙ† Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if (plan.strategy === ResponseStrategy.INFORMATIVE || 
            plan.strategy === ResponseStrategy.EDUCATIONAL) {
            let details = new ResponseComponent(
                `component-details-${Date.now()}`,
                "details",
                order++
            );
            details.isOptional = true;
            plan.addComponent(details);
        }

        // Ù…ÙƒÙˆÙ† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if (plan.strategy === ResponseStrategy.SUPPORTIVE) {
            let suggestions = new ResponseComponent(
                `component-suggestions-${Date.now()}`,
                "suggestions",
                order++
            );
            suggestions.isOptional = true;
            plan.addComponent(suggestions);
        }

        // Ù…ÙƒÙˆÙ† Ø§Ù„Ø®ØªØ§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        let closing = new ResponseComponent(
            `component-closing-${Date.now()}`,
            "closing",
            order++
        );
        closing.isOptional = true;
        plan.addComponent(closing);
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
     */
    private identifyRequiredData(plan: ResponsePlan): void {
        let analysis = plan.intentAnalysis;

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª
        let entities = analysis.getAllEntities();
        for (let entity of entities) {
            plan.addRequiredData(`entity_${entity.type}`, entity.value);
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
        if (analysis.primaryIntent && analysis.primaryIntent.keywords.length > 0) {
            plan.addRequiredData("keywords", analysis.primaryIntent.keywords.join(", "));
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
        plan.addRequiredData("original_text", analysis.inputText);

        // Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø§Ù„Ù†ÙŠØ©
        if (analysis.primaryIntent) {
            plan.addRequiredData("intent_type", analysis.primaryIntent.type);
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    private updateStats(plan: ResponsePlan): void {
        this.stats.totalPlans++;

        // ØªØ­Ø¯ÙŠØ« ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª
        let count = this.stats.strategyDistribution.get(plan.strategy) || 0;
        this.stats.strategyDistribution.set(plan.strategy, count + 1);

        // ØªØ­Ø¯ÙŠØ« Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        let totalComponents = this.stats.averageComponents * (this.stats.totalPlans - 1);
        totalComponents += plan.components.length;
        this.stats.averageComponents = totalComponents / this.stats.totalPlans;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    getStats(): any {
        return {
            totalPlans: this.stats.totalPlans,
            averageComponents: this.stats.averageComponents.toFixed(1),
            strategyDistribution: Object.fromEntries(this.stats.strategyDistribution)
        };
    }
}

