/**
 * Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - Integrated Memory System
 * 
 * ÙŠØ¯Ù…Ø¬ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©:
 * 1. Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø­Ø¯Ø«ÙŠØ© (Episodic Memory) - Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø¨
 * 2. Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© (Semantic Memory) - Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙˆØ§Ù„Ø­Ù‚Ø§Ø¦Ù‚
 * 3. Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø© (Working Memory) - Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
 * 
 * Ù…Ø¹ Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
 * 
 * @author Ø¨Ø§Ø³Ù„ ÙŠØ­ÙŠÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡
 * @version 1.0.0
 * @date 2025-10-27
 */

import { EpisodicMemory, DialogueEpisode, EpisodeType } from "./episodic-memory.bn";
import { SemanticMemory, Fact, Concept } from "./semantic-memory.bn";
import { WorkingMemory, ItemType } from "./working-memory.bn";
import { AdvancedContextTracker } from "./context-tracker.bn";

/**
 * ÙØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - IntegratedMemorySystem
 * 
 * ÙŠØ¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆÙŠÙˆÙØ± ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©
 */
class IntegratedMemorySystem {
    // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    private episodicMemory: EpisodicMemory;
    private semanticMemory: SemanticMemory;
    private workingMemory: WorkingMemory;
    private contextTracker: AdvancedContextTracker;
    
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    private consolidationInterval: number;
    private lastConsolidation: Date;
    
    /**
     * Ø§Ù„Ù…ÙÙ†Ø´Ø¦
     */
    constructor(
        maxEpisodes: number = 1000,
        maxFacts: number = 10000,
        workingMemoryCapacity: number = 7
    ) {
        // ØªÙ‡ÙŠØ¦Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        this.episodicMemory = new EpisodicMemory(maxEpisodes);
        this.semanticMemory = new SemanticMemory(maxFacts);
        this.workingMemory = new WorkingMemory(workingMemoryCapacity);
        this.contextTracker = new AdvancedContextTracker();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ù…Ø¬
        this.consolidationInterval = 3600000; // Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©
        this.lastConsolidation = new Date();
        
        console.log("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„");
    }
    
    /**
     * ØªØ°ÙƒØ± - Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
     */
    public remember(data: object): string {
        let memoryType = data.type || "fact";
        
        if (memoryType === "dialogue") {
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø­Ø¯Ø«ÙŠØ©
            return this.episodicMemory.storeDialogue(
                data.userInput || "",
                data.botResponse || "",
                data.intent || "unknown",
                data.entities || [],
                data.topics || [],
                data.context || {},
                data.success !== false
            );
        } else if (memoryType === "fact") {
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©
            return this.semanticMemory.storeFact(
                data.subject || "",
                data.predicate || "",
                data.object || "",
                data.confidence || 1.0,
                data.source || "learned",
                data.domain || "general"
            );
        } else if (memoryType === "concept") {
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©
            return this.semanticMemory.storeConcept(
                data.name || "",
                data.definition || "",
                data.properties || {},
                data.examples || []
            );
        } else if (memoryType === "temporary") {
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø©
            return this.workingMemory.store(
                data.key || "",
                data.value,
                data.itemType || ItemType.DATA,
                data.priority || 0,
                data.ttl || null
            );
        }
        
        return "";
    }
    
    /**
     * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ - Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
     */
    public recall(query: object): any {
        let queryType = query.type || "recent";
        
        if (queryType === "recent") {
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø®ÙŠØ±Ø©
            return this.episodicMemory.retrieveRecent(
                query.count || 10,
                query.episodeType || null
            );
        } else if (queryType === "topic") {
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹
            return this.episodicMemory.retrieveByTopic(
                query.topic || "",
                query.maxCount || 10
            );
        } else if (queryType === "fact") {
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ù‚Ø§Ø¦Ù‚
            return this.semanticMemory.retrieveFactsAbout(
                query.subject || "",
                query.maxCount || 10
            );
        } else if (queryType === "concept") {
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…ÙÙ‡ÙˆÙ…
            return this.semanticMemory.retrieveConcept(query.name || "");
        } else if (queryType === "working") {
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø©
            return this.workingMemory.retrieve(query.key || "");
        } else if (queryType === "context") {
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
            return this.contextTracker.getCurrentContext();
        }
        
        return null;
    }
    
    /**
     * ØªØ¹Ù„Ù… - Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† ØªØ¬Ø±Ø¨Ø©
     */
    public learn(experience: object): void {
        // Ø­ÙØ¸ Ø§Ù„ØªØ¬Ø±Ø¨Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø­Ø¯Ø«ÙŠØ©
        let episodeId = this.episodicMemory.storeDialogue(
            experience.userInput || "",
            experience.botResponse || "",
            experience.intent || "unknown",
            experience.entities || [],
            experience.topics || [],
            experience.context || {},
            experience.success !== false
        );
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø­Ù‚Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„ØªØ¬Ø±Ø¨Ø©
        if (experience.facts && Array.isArray(experience.facts)) {
            for (let fact of experience.facts) {
                this.semanticMemory.storeFact(
                    fact.subject,
                    fact.predicate,
                    fact.object,
                    fact.confidence || 0.8,
                    "learned"
                );
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ§Ù‚
        if (experience.turnNumber) {
            this.contextTracker.updateContext(
                experience.turnNumber,
                experience.userInput || "",
                experience.entities || []
            );
        }
    }
    
    /**
     * Ø¯Ù…Ø¬ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª - Ù†Ù‚Ù„ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø© Ø¥Ù„Ù‰ Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰
     */
    public consolidate(): void {
        let now = new Date();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ù…Ù†Ø° Ø¢Ø®Ø± Ø¯Ù…Ø¬
        if (now.getTime() - this.lastConsolidation.getTime() < this.consolidationInterval) {
            return;
        }
        
        console.log("ğŸ”„ Ø¨Ø¯Ø¡ Ø¯Ù…Ø¬ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª...");
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø©
        let workingItems = this.workingMemory.getAll();
        
        // Ù†Ù‚Ù„ Ø§Ù„Ø­Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©
        for (let key in workingItems) {
            let value = workingItems[key];
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ù‚ÙŠÙ‚Ø©
            if (value && typeof value === "object" && value.subject && value.predicate && value.object) {
                this.semanticMemory.storeFact(
                    value.subject,
                    value.predicate,
                    value.object,
                    value.confidence || 0.7,
                    "consolidated"
                );
            }
        }
        
        this.lastConsolidation = now;
        console.log("âœ… ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª");
    }
    
    /**
     * Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„ - Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
     */
    public search(searchTerm: string, maxResults: number = 10): object {
        let results = {
            episodes: [],
            facts: [],
            concepts: [],
            context: null
        };
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø­Ø¯Ø«ÙŠØ©
        results.episodes = this.episodicMemory.retrieveByTopic(searchTerm, maxResults);
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©
        results.facts = this.semanticMemory.retrieveFactsAbout(searchTerm, maxResults);
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙÙ‡ÙˆÙ…
        let concept = this.semanticMemory.retrieveConcept(searchTerm);
        if (concept !== null) {
            results.concepts = [concept];
        }
        
        // Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
        results.context = this.contextTracker.getCurrentContext();
        
        return results;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø­Ø¯Ø«ÙŠØ©
     */
    public getEpisodicMemory(): EpisodicMemory {
        return this.episodicMemory;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©
     */
    public getSemanticMemory(): SemanticMemory {
        return this.semanticMemory;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø©
     */
    public getWorkingMemory(): WorkingMemory {
        return this.workingMemory;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚
     */
    public getContextTracker(): AdvancedContextTracker {
        return this.contextTracker;
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©
     */
    public getStatistics(): object {
        return {
            episodic: this.episodicMemory.getStatistics(),
            semantic: this.semanticMemory.getStatistics(),
            working: this.workingMemory.getStatistics(),
            context: this.contextTracker.getStatistics(),
            lastConsolidation: this.lastConsolidation
        };
    }
    
    /**
     * Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
     */
    public clearAll(): void {
        this.workingMemory.clear();
        console.log("ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø©");
    }
}

// ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ¦Ø©
export { IntegratedMemorySystem };
