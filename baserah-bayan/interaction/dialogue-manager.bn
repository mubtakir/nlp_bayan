/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ—£ï¸ Ù…Ø¯ÙŠØ± Ø§Ù„Ø­ÙˆØ§Ø± - Dialogue Manager
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø°ÙƒÙŠ Ø¨Ø¯ÙˆÙ† Ø´Ø¨ÙƒØ§Øª Ø¹ØµØ¨ÙŠØ©
 * ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø§Ù„ØªÙƒÙŠÙÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª
 * 
 * Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª:
 * - Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ø± (Dialogue State)
 * - ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚ (Context Tracking)
 * - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Turn Management)
 * - Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„Ø­ÙˆØ§Ø± (Dialogue Strategies)
 * 
 * @author Al-Mubtakir
 * @version 1.0.0
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

import { MotherEquation } from "../core/mother-equation.bn";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ Ø§Ù„ØªØ¹Ø¯Ø§Ø¯Ø§Øª - Enumerations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ø£Ù†ÙˆØ§Ø¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­ÙˆØ§Ø±
 */
enum DialogueState {
    GREETING = "greeting",              // Ø§Ù„ØªØ­ÙŠØ©
    INFORMATION_GATHERING = "info_gathering",  // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    CLARIFICATION = "clarification",    // Ø§Ù„ØªÙˆØ¶ÙŠØ­
    CONFIRMATION = "confirmation",      // Ø§Ù„ØªØ£ÙƒÙŠØ¯
    EXECUTION = "execution",            // Ø§Ù„ØªÙ†ÙÙŠØ°
    FEEDBACK = "feedback",              // Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©
    CLOSING = "closing",                // Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    ERROR_HANDLING = "error_handling"   // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
}

/**
 * Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙÙŠ Ø§Ù„Ø­ÙˆØ§Ø±
 */
enum TurnType {
    USER_INITIATIVE = "user_initiative",      // Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    SYSTEM_INITIATIVE = "system_initiative",  // Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    MIXED_INITIATIVE = "mixed_initiative",    // Ù…Ø¨Ø§Ø¯Ø±Ø© Ù…Ø®ØªÙ„Ø·Ø©
    CLARIFICATION_REQUEST = "clarification_request",  // Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­
    CONFIRMATION_REQUEST = "confirmation_request"     // Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯
}

/**
 * Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„Ø­ÙˆØ§Ø±
 */
enum DialogueStrategy {
    DIRECT = "direct",                  // Ù…Ø¨Ø§Ø´Ø±
    GUIDED = "guided",                  // Ù…ÙˆØ¬Ù‡
    EXPLORATORY = "exploratory",        // Ø§Ø³ØªÙƒØ´Ø§ÙÙŠ
    COLLABORATIVE = "collaborative",    // ØªØ¹Ø§ÙˆÙ†ÙŠ
    ADAPTIVE = "adaptive",              // ØªÙƒÙŠÙÙŠ
    PROACTIVE = "proactive",            // Ø§Ø³ØªØ¨Ø§Ù‚ÙŠ
    REACTIVE = "reactive"               // ØªÙØ§Ø¹Ù„ÙŠ
}

/**
 * Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø«Ù‚Ø© ÙÙŠ ÙÙ‡Ù… Ø§Ù„Ø­ÙˆØ§Ø±
 */
enum ConfidenceLevel {
    VERY_HIGH = "very_high",    // Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ (> 0.9)
    HIGH = "high",              // Ø¹Ø§Ù„ÙŠØ© (0.7 - 0.9)
    MEDIUM = "medium",          // Ù…ØªÙˆØ³Ø·Ø© (0.5 - 0.7)
    LOW = "low",                // Ù…Ù†Ø®ÙØ¶Ø© (0.3 - 0.5)
    VERY_LOW = "very_low"       // Ù…Ù†Ø®ÙØ¶Ø© Ø¬Ø¯Ø§Ù‹ (< 0.3)
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ Ø§Ù„ÙØ¦Ø§Øª - Classes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ø¯ÙˆØ± ÙÙŠ Ø§Ù„Ø­ÙˆØ§Ø± (Turn)
 */
class DialogueTurn extends MotherEquation {
    public speaker: string;           // Ø§Ù„Ù…ØªØ­Ø¯Ø« (user/system)
    public utterance: string;         // Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø·ÙˆÙ‚
    public intent: string;            // Ø§Ù„Ù†ÙŠØ©
    public entities: object;          // Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
    public timestamp: number;         // Ø§Ù„ÙˆÙ‚Øª
    public turnType: TurnType;        // Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ±
    public confidence: number;        // Ø§Ù„Ø«Ù‚Ø© ÙÙŠ Ø§Ù„ÙÙ‡Ù…
    
    constructor(speaker: string, utterance: string, intent: string) {
        super(`turn_${Date.now()}`);
        this.speaker = speaker;
        this.utterance = utterance;
        this.intent = intent;
        this.entities = {};
        this.timestamp = Date.now();
        this.turnType = TurnType.USER_INITIATIVE;
        this.confidence = 0.8;
        
        // Î¦: Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø«Ø§Ø¨ØªØ©
        this.fixedProperties = {
            speaker: speaker,
            utterance: utterance,
            timestamp: this.timestamp
        };
        
        // Î¨: Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        this.dynamicStates = {
            intent: intent,
            entities: this.entities,
            confidence: this.confidence
        };
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© ÙƒÙŠØ§Ù† Ù…Ø³ØªØ®Ø±Ø¬
     */
    public addEntity(entityType: string, value: any): void {
        this.entities[entityType] = value;
        this.dynamicStates.entities = this.entities;
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø«Ù‚Ø©
     */
    public updateConfidence(confidence: number): void {
        this.confidence = Math.max(0, Math.min(1, confidence));
        this.dynamicStates.confidence = this.confidence;
    }
}

/**
 * Ø³ÙŠØ§Ù‚ Ø§Ù„Ø­ÙˆØ§Ø± (Dialogue Context)
 */
class DialogueContext extends MotherEquation {
    public currentState: DialogueState;     // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    public previousStates: array<DialogueState>;  // Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    public activeTopics: array<string>;     // Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø©
    public userGoals: array<string>;        // Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    public systemGoals: array<string>;      // Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù…
    public sharedKnowledge: object;         // Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
    public turnHistory: array<DialogueTurn>; // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
    
    constructor(contextId: string) {
        super(contextId);
        this.currentState = DialogueState.GREETING;
        this.previousStates = [];
        this.activeTopics = [];
        this.userGoals = [];
        this.systemGoals = [];
        this.sharedKnowledge = {};
        this.turnHistory = [];
        
        // Î¦: Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø«Ø§Ø¨ØªØ©
        this.fixedProperties = {
            contextId: contextId,
            startTime: Date.now()
        };
        
        // Î¨: Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        this.dynamicStates = {
            currentState: this.currentState,
            activeTopics: this.activeTopics,
            turnCount: 0
        };
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ø±
     */
    public updateState(newState: DialogueState): void {
        this.previousStates.push(this.currentState);
        this.currentState = newState;
        this.dynamicStates.currentState = newState;
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ± Ø¬Ø¯ÙŠØ¯
     */
    public addTurn(turn: DialogueTurn): void {
        this.turnHistory.push(turn);
        this.dynamicStates.turnCount = this.turnHistory.length;
    }
    
    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¶ÙˆØ¹ Ù†Ø´Ø·
     */
    public addTopic(topic: string): void {
        if (!this.activeTopics.includes(topic)) {
            this.activeTopics.push(topic);
            this.dynamicStates.activeTopics = this.activeTopics;
        }
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ù…ÙˆØ¶ÙˆØ¹
     */
    public removeTopic(topic: string): void {
        let index = this.activeTopics.indexOf(topic);
        if (index > -1) {
            this.activeTopics.splice(index, 1);
            this.dynamicStates.activeTopics = this.activeTopics;
        }
    }
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± N Ø£Ø¯ÙˆØ§Ø±
     */
    public getRecentTurns(n: number): array<DialogueTurn> {
        let start = Math.max(0, this.turnHistory.length - n);
        return this.turnHistory.slice(start);
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
     */
    public updateSharedKnowledge(key: string, value: any): void {
        this.sharedKnowledge[key] = value;
    }
}

/**
 * Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ø± (Dialogue Strategy Handler)
 */
class DialogueStrategyHandler extends MotherEquation {
    public strategy: DialogueStrategy;
    public adaptationRate: number;        // Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙƒÙŠÙ
    public proactivityLevel: number;      // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ø³ØªØ¨Ø§Ù‚ÙŠØ©
    
    constructor(strategy: DialogueStrategy) {
        super(`strategy_${strategy}`);
        this.strategy = strategy;
        this.adaptationRate = 0.5;
        this.proactivityLevel = 0.5;
        
        // Î¦: Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø«Ø§Ø¨ØªØ©
        this.fixedProperties = {
            strategyType: strategy
        };
        
        // Î¨: Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        this.dynamicStates = {
            adaptationRate: this.adaptationRate,
            proactivityLevel: this.proactivityLevel
        };
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ
     */
    public determineNextTurnType(context: DialogueContext): TurnType {
        // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
        if (this.strategy === DialogueStrategy.DIRECT) {
            return TurnType.SYSTEM_INITIATIVE;
        }
        
        // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù…ÙˆØ¬Ù‡Ø©
        if (this.strategy === DialogueStrategy.GUIDED) {
            return context.turnHistory.length % 2 === 0 
                ? TurnType.SYSTEM_INITIATIVE 
                : TurnType.USER_INITIATIVE;
        }
        
        // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªØ¹Ø§ÙˆÙ†ÙŠØ©
        if (this.strategy === DialogueStrategy.COLLABORATIVE) {
            return TurnType.MIXED_INITIATIVE;
        }
        
        // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªÙƒÙŠÙÙŠØ©
        if (this.strategy === DialogueStrategy.ADAPTIVE) {
            let recentTurns = context.getRecentTurns(3);
            let avgConfidence = this.calculateAverageConfidence(recentTurns);
            
            if (avgConfidence < 0.5) {
                return TurnType.CLARIFICATION_REQUEST;
            }
            return TurnType.MIXED_INITIATIVE;
        }
        
        return TurnType.USER_INITIATIVE;
    }
    
    /**
     * Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø«Ù‚Ø©
     */
    private calculateAverageConfidence(turns: array<DialogueTurn>): number {
        if (turns.length === 0) return 0.8;
        
        let sum = 0;
        for (let turn of turns) {
            sum += turn.confidence;
        }
        return sum / turns.length;
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­
     */
    public shouldRequestClarification(turn: DialogueTurn): boolean {
        return turn.confidence < 0.6;
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯
     */
    public shouldRequestConfirmation(turn: DialogueTurn): boolean {
        return turn.confidence >= 0.6 && turn.confidence < 0.8;
    }
}

/**
 * Ù…Ø¯ÙŠØ± Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Dialogue Manager)
 */
class DialogueManager extends MotherEquation {
    public context: DialogueContext;
    public strategyHandler: DialogueStrategyHandler;
    public currentStrategy: DialogueStrategy;
    public dialogueHistory: array<DialogueContext>;
    public activeDialogues: object;

    constructor(managerId: string) {
        super(managerId);
        this.context = new DialogueContext("main_context");
        this.currentStrategy = DialogueStrategy.ADAPTIVE;
        this.strategyHandler = new DialogueStrategyHandler(this.currentStrategy);
        this.dialogueHistory = [];
        this.activeDialogues = {};

        // Î¦: Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø«Ø§Ø¨ØªØ©
        this.fixedProperties = {
            managerId: managerId,
            createdAt: Date.now()
        };

        // Î¨: Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        this.dynamicStates = {
            currentState: this.context.currentState,
            activeDialogueCount: 0,
            totalTurns: 0
        };
    }

    /**
     * Ø¨Ø¯Ø¡ Ø­ÙˆØ§Ø± Ø¬Ø¯ÙŠØ¯
     */
    public startDialogue(dialogueId: string, strategy: DialogueStrategy): DialogueContext {
        let newContext = new DialogueContext(dialogueId);
        this.activeDialogues[dialogueId] = newContext;
        this.context = newContext;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
        this.currentStrategy = strategy;
        this.strategyHandler = new DialogueStrategyHandler(strategy);

        this.dynamicStates.activeDialogueCount = Object.keys(this.activeDialogues).length;

        return newContext;
    }

    /**
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    public processUserTurn(utterance: string, intent: string, entities: object): DialogueTurn {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ± Ø¬Ø¯ÙŠØ¯
        let turn = new DialogueTurn("user", utterance, intent);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª
        for (let entityType in entities) {
            turn.addEntity(entityType, entities[entityType]);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ± Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚
        this.context.addTurn(turn);
        this.dynamicStates.totalTurns++;

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙŠØ©
        this.updateDialogueState(intent, turn);

        return turn;
    }

    /**
     * ØªÙˆÙ„ÙŠØ¯ Ø¯ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…
     */
    public generateSystemTurn(responseText: string, intent: string): DialogueTurn {
        let turn = new DialogueTurn("system", responseText, intent);
        turn.turnType = this.strategyHandler.determineNextTurnType(this.context);

        this.context.addTurn(turn);
        this.dynamicStates.totalTurns++;

        return turn;
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ø±
     */
    private updateDialogueState(intent: string, turn: DialogueTurn): void {
        // Ø§Ù„ØªØ­ÙŠØ©
        if (intent === "greeting") {
            this.context.updateState(DialogueState.GREETING);
        }
        // Ø·Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        else if (intent === "request_info" || intent === "query") {
            this.context.updateState(DialogueState.INFORMATION_GATHERING);
        }
        // Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­
        else if (intent === "clarify" || turn.confidence < 0.6) {
            this.context.updateState(DialogueState.CLARIFICATION);
        }
        // ØªØ£ÙƒÙŠØ¯
        else if (intent === "confirm" || intent === "yes") {
            this.context.updateState(DialogueState.CONFIRMATION);
        }
        // ØªÙ†ÙÙŠØ°
        else if (intent === "execute" || intent === "action") {
            this.context.updateState(DialogueState.EXECUTION);
        }
        // Ø¥ØºÙ„Ø§Ù‚
        else if (intent === "goodbye" || intent === "end") {
            this.context.updateState(DialogueState.CLOSING);
        }
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡
        else if (turn.confidence < 0.3) {
            this.context.updateState(DialogueState.ERROR_HANDLING);
        }

        this.dynamicStates.currentState = this.context.currentState;
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­
     */
    public shouldClarify(turn: DialogueTurn): boolean {
        return this.strategyHandler.shouldRequestClarification(turn);
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯
     */
    public shouldConfirm(turn: DialogueTurn): boolean {
        return this.strategyHandler.shouldRequestConfirmation(turn);
    }

    /**
     * Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­ÙˆØ§Ø±
     */
    public endDialogue(dialogueId: string): void {
        if (this.activeDialogues[dialogueId]) {
            this.dialogueHistory.push(this.activeDialogues[dialogueId]);
            delete this.activeDialogues[dialogueId];
            this.dynamicStates.activeDialogueCount = Object.keys(this.activeDialogues).length;
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ø§Ù„Ø­ÙˆØ§Ø±
     */
    public getDialogueSummary(): object {
        return {
            currentState: this.context.currentState,
            turnCount: this.context.turnHistory.length,
            activeTopics: this.context.activeTopics,
            userGoals: this.context.userGoals,
            systemGoals: this.context.systemGoals,
            strategy: this.currentStrategy,
            totalDialogues: this.dialogueHistory.length,
            activeDialogues: Object.keys(this.activeDialogues).length
        };
    }

    /**
     * ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
     */
    public changeStrategy(newStrategy: DialogueStrategy): void {
        this.currentStrategy = newStrategy;
        this.strategyHandler = new DialogueStrategyHandler(newStrategy);
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
     */
    public getCurrentConfidenceLevel(): ConfidenceLevel {
        let recentTurns = this.context.getRecentTurns(3);
        if (recentTurns.length === 0) return ConfidenceLevel.MEDIUM;

        let avgConfidence = 0;
        for (let turn of recentTurns) {
            avgConfidence += turn.confidence;
        }
        avgConfidence /= recentTurns.length;

        if (avgConfidence > 0.9) return ConfidenceLevel.VERY_HIGH;
        if (avgConfidence > 0.7) return ConfidenceLevel.HIGH;
        if (avgConfidence > 0.5) return ConfidenceLevel.MEDIUM;
        if (avgConfidence > 0.3) return ConfidenceLevel.LOW;
        return ConfidenceLevel.VERY_LOW;
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    public addUserGoal(goal: string): void {
        this.context.userGoals.push(goal);
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ù„Ù„Ù†Ø¸Ø§Ù…
     */
    public addSystemGoal(goal: string): void {
        this.context.systemGoals.push(goal);
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
     */
    public checkGoalsCompletion(): object {
        return {
            userGoalsCompleted: this.context.userGoals.length,
            systemGoalsCompleted: this.context.systemGoals.length,
            totalGoals: this.context.userGoals.length + this.context.systemGoals.length
        };
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¤ Ø§Ù„ØªØµØ¯ÙŠØ± - Exports
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export {
    DialogueState,
    TurnType,
    DialogueStrategy,
    ConfidenceLevel,
    DialogueTurn,
    DialogueContext,
    DialogueStrategyHandler,
    DialogueManager
};

