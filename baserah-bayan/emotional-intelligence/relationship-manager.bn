/**
 * Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
 * Relationship Manager
 * 
 * ÙŠØ¯ÙŠØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
 */

import { MotherEquation } from "../core/mother-equation.bn";

// ==================== Ø§Ù„ØªØ¹Ø¯Ø§Ø¯Ø§Øª ====================

/**
 * Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
 * Relationship Types
 */
export enum RelationshipType {
    PROFESSIONAL = "Ù…Ù‡Ù†ÙŠØ©",
    PERSONAL = "Ø´Ø®ØµÙŠØ©",
    MENTOR_MENTEE = "Ù…Ø±Ø´Ø¯-Ù…ØªØ¯Ø±Ø¨",
    COLLABORATIVE = "ØªØ¹Ø§ÙˆÙ†ÙŠØ©",
    SUPPORTIVE = "Ø¯Ø§Ø¹Ù…Ø©",
    CASUAL = "Ø¹Ø§Ø¯ÙŠØ©"
}

/**
 * Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©
 * Relationship Stages
 */
export enum RelationshipStage {
    INITIAL = "Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©",
    DEVELOPING = "Ø§Ù„ØªØ·ÙˆÙŠØ±",
    ESTABLISHED = "Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±",
    MATURE = "Ø§Ù„Ù†Ø¶Ø¬",
    DECLINING = "Ø§Ù„ØªØ±Ø§Ø¬Ø¹"
}

/**
 * Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„
 * Interaction Quality
 */
export enum InteractionQuality {
    EXCELLENT = "Ù…Ù…ØªØ§Ø²",
    GOOD = "Ø¬ÙŠØ¯",
    NEUTRAL = "Ù…Ø­Ø§ÙŠØ¯",
    POOR = "Ø¶Ø¹ÙŠÙ",
    NEGATIVE = "Ø³Ù„Ø¨ÙŠ"
}

// ==================== Ø§Ù„ÙØ¦Ø§Øª ====================

/**
 * Ø³Ø¬Ù„ ØªÙØ§Ø¹Ù„
 * Interaction Record
 */
export class InteractionRecord extends MotherEquation {
    public recordId: string;
    public relationshipId: string;
    public quality: InteractionQuality;
    public sentiment: number; // -1.0 to 1.0
    public topics: Array<string>;
    public duration: number; // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
    public notes: string;
    public timestamp: number;

    constructor(
        relationshipId: string,
        quality: InteractionQuality,
        sentiment: number = 0
    ) {
        super(`interaction_${Date.now()}`, {}, {});
        this.recordId = this.id;
        this.relationshipId = relationshipId;
        this.quality = quality;
        this.sentiment = Math.max(-1, Math.min(1, sentiment));
        this.topics = [];
        this.duration = 0;
        this.notes = "";
        this.timestamp = Date.now();
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¶ÙˆØ¹
     */
    public addTopic(topic: string): void {
        if (!this.topics.includes(topic)) {
            this.topics.push(topic);
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØµÙ Ø§Ù„ØªÙØ§Ø¹Ù„
     */
    public getDescription(): string {
        let desc = `ØªÙØ§Ø¹Ù„: ${this.quality}\n`;
        desc += `Ø§Ù„Ù…Ø´Ø§Ø¹Ø±: ${(this.sentiment * 100).toFixed(0)}%\n`;
        desc += `Ø§Ù„Ù…Ø¯Ø©: ${this.duration.toFixed(1)} Ø¯Ù‚ÙŠÙ‚Ø©\n`;
        
        if (this.topics.length > 0) {
            desc += `Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹: ${this.topics.join(", ")}\n`;
        }
        
        if (this.notes) {
            desc += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${this.notes}\n`;
        }

        return desc;
    }
}

/**
 * Ø¹Ù„Ø§Ù‚Ø©
 * Relationship
 */
export class Relationship extends MotherEquation {
    public relationshipId: string;
    public userId: string;
    public relationshipType: RelationshipType;
    public stage: RelationshipStage;
    public strength: number; // 0.0 - 1.0
    public trustLevel: number; // 0.0 - 1.0
    public interactionCount: number;
    public positiveInteractions: number;
    public negativeInteractions: number;
    public lastInteraction: number | null;
    public createdAt: number;
    public notes: Array<string>;
    public interactions: Array<InteractionRecord>;

    constructor(
        userId: string,
        relationshipType: RelationshipType,
        initialStrength: number = 0.5
    ) {
        super(`relationship_${Date.now()}`, {}, {});
        this.relationshipId = this.id;
        this.userId = userId;
        this.relationshipType = relationshipType;
        this.stage = RelationshipStage.INITIAL;
        this.strength = Math.max(0, Math.min(1, initialStrength));
        this.trustLevel = 0.5;
        this.interactionCount = 0;
        this.positiveInteractions = 0;
        this.negativeInteractions = 0;
        this.lastInteraction = null;
        this.createdAt = Date.now();
        this.notes = [];
        this.interactions = [];
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
     */
    public addNote(note: string): void {
        this.notes.push(note);
    }

    /**
     * ØªØ³Ø¬ÙŠÙ„ ØªÙØ§Ø¹Ù„
     */
    public recordInteraction(interaction: InteractionRecord): void {
        this.interactions.push(interaction);
        this.interactionCount++;
        this.lastInteraction = interaction.timestamp;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        if (interaction.sentiment > 0.3) {
            this.positiveInteractions++;
            this.strength = Math.min(1.0, this.strength + 0.05);
            this.trustLevel = Math.min(1.0, this.trustLevel + 0.03);
        } else if (interaction.sentiment < -0.3) {
            this.negativeInteractions++;
            this.strength = Math.max(0, this.strength - 0.05);
            this.trustLevel = Math.max(0, this.trustLevel - 0.03);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø­Ù„Ø©
        this.updateStage();
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©
     */
    private updateStage(): void {
        if (this.interactionCount < 5) {
            this.stage = RelationshipStage.INITIAL;
        } else if (this.interactionCount < 15) {
            this.stage = RelationshipStage.DEVELOPING;
        } else if (this.interactionCount < 50) {
            this.stage = RelationshipStage.ESTABLISHED;
        } else {
            if (this.getHealthScore() > 0.7) {
                this.stage = RelationshipStage.MATURE;
            } else {
                this.stage = RelationshipStage.DECLINING;
            }
        }
    }

    /**
     * Ø­Ø³Ø§Ø¨ ØµØ­Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©
     */
    public getHealthScore(): number {
        // Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©
        let positivityRatio = this.interactionCount === 0 
            ? 0.5 
            : this.positiveInteractions / this.interactionCount;

        // Ø§Ù„ÙˆÙ‚Øª Ù…Ù†Ø° Ø¢Ø®Ø± ØªÙØ§Ø¹Ù„
        let recencyScore = 0;
        if (this.lastInteraction) {
            let daysSince = (Date.now() - this.lastInteraction) / (1000 * 60 * 60 * 24);
            recencyScore = Math.max(0, 1.0 - (daysSince / 30)); // ÙŠÙ†Ø®ÙØ¶ Ø¨Ø¹Ø¯ 30 ÙŠÙˆÙ…
        }

        // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        let health = (
            this.strength * 0.3 +
            this.trustLevel * 0.3 +
            positivityRatio * 0.2 +
            recencyScore * 0.2
        );

        return Math.min(1.0, health);
    }

    /**
     * Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…ØŸ
     */
    public needsAttention(): boolean {
        return this.getHealthScore() < 0.5;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ§Øª
     */
    public getRecommendations(): Array<string> {
        let recommendations: Array<string> = [];

        if (this.needsAttention()) {
            recommendations.push("âš ï¸ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù‡ØªÙ…Ø§Ù…");
        }

        if (this.lastInteraction) {
            let daysSince = (Date.now() - this.lastInteraction) / (1000 * 60 * 60 * 24);
            if (daysSince > 7) {
                recommendations.push(`Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù†Ø° ${daysSince.toFixed(0)} ÙŠÙˆÙ…`);
            }
        }

        if (this.trustLevel < 0.5) {
            recommendations.push("Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø© Ù…Ù†Ø®ÙØ¶ - ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¨Ù†Ø§Ø¡");
        }

        if (this.strength < 0.5) {
            recommendations.push("Ù‚ÙˆØ© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¶Ø¹ÙŠÙØ© - ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹Ø²ÙŠØ²");
        }

        let positivityRatio = this.interactionCount === 0 
            ? 0 
            : this.positiveInteractions / this.interactionCount;
        
        if (positivityRatio < 0.5) {
            recommendations.push("Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©");
        }

        return recommendations;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØµÙ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©
     */
    public getDescription(): string {
        let desc = `Ø¹Ù„Ø§Ù‚Ø© Ù…Ø¹: ${this.userId}\n`;
        desc += `Ø§Ù„Ù†ÙˆØ¹: ${this.relationshipType}\n`;
        desc += `Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${this.stage}\n`;
        desc += `Ø§Ù„Ù‚ÙˆØ©: ${(this.strength * 100).toFixed(0)}%\n`;
        desc += `Ø§Ù„Ø«Ù‚Ø©: ${(this.trustLevel * 100).toFixed(0)}%\n`;
        desc += `ØµØ­Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©: ${(this.getHealthScore() * 100).toFixed(0)}%\n`;
        desc += `Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª: ${this.interactionCount}\n`;
        desc += `Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©: ${this.positiveInteractions} | Ø³Ù„Ø¨ÙŠØ©: ${this.negativeInteractions}\n`;

        if (this.lastInteraction) {
            let daysSince = (Date.now() - this.lastInteraction) / (1000 * 60 * 60 * 24);
            desc += `Ø¢Ø®Ø± ØªÙØ§Ø¹Ù„: Ù…Ù†Ø° ${daysSince.toFixed(0)} ÙŠÙˆÙ…\n`;
        }

        let recommendations = this.getRecommendations();
        if (recommendations.length > 0) {
            desc += `\nØªÙˆØµÙŠØ§Øª:\n`;
            recommendations.forEach((rec, i) => {
                desc += `  ${i + 1}. ${rec}\n`;
            });
        }

        return desc;
    }
}

/**
 * Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
 * Relationship Manager
 */
export class RelationshipManager extends MotherEquation {
    public relationships: Map<string, Relationship>;
    public interactionHistory: Array<InteractionRecord>;
    public maxHistorySize: number;

    constructor() {
        super("relationship_manager", {}, {});
        this.relationships = new Map();
        this.interactionHistory = [];
        this.maxHistorySize = 1000;
    }

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
     */
    public createRelationship(
        userId: string,
        relationshipType: RelationshipType,
        initialStrength: number = 0.5
    ): Relationship {
        let relationship = new Relationship(userId, relationshipType, initialStrength);
        this.relationships.set(userId, relationship);

        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹: ${userId} (${relationshipType})`);

        return relationship;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù‚Ø©
     */
    public getRelationship(userId: string): Relationship | null {
        return this.relationships.get(userId) || null;
    }

    /**
     * ØªØ³Ø¬ÙŠÙ„ ØªÙØ§Ø¹Ù„
     */
    public recordInteraction(
        userId: string,
        quality: InteractionQuality,
        sentiment: number = 0,
        topics: Array<string> = [],
        duration: number = 0
    ): InteractionRecord {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
        let relationship = this.getRelationship(userId);
        if (!relationship) {
            relationship = this.createRelationship(userId, RelationshipType.CASUAL);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„
        let interaction = new InteractionRecord(relationship.relationshipId, quality, sentiment);
        interaction.duration = duration;
        topics.forEach(topic => interaction.addTopic(topic));

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„
        relationship.recordInteraction(interaction);
        this.interactionHistory.push(interaction);

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„ Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯
        if (this.interactionHistory.length > this.maxHistorySize) {
            this.interactionHistory.shift();
        }

        console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªÙØ§Ø¹Ù„ Ù…Ø¹ ${userId}: ${quality} (Ù…Ø´Ø§Ø¹Ø±: ${(sentiment * 100).toFixed(0)}%)`);

        return interaction;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Ù‹
     */
    public getRelationshipsNeedingAttention(): Array<Relationship> {
        let needingAttention: Array<Relationship> = [];

        this.relationships.forEach(relationship => {
            if (relationship.needsAttention()) {
                needingAttention.push(relationship);
            }
        });

        return needingAttention;
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
     */
    public getStrongestRelationships(limit: number = 5): Array<Relationship> {
        let allRelationships = Array.from(this.relationships.values());

        return allRelationships
            .sort((a, b) => b.getHealthScore() - a.getHealthScore())
            .slice(0, limit);
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    public getStatistics(): any {
        let totalRelationships = this.relationships.size;
        let totalInteractions = this.interactionHistory.length;

        let avgHealth = 0;
        let avgTrust = 0;
        let avgStrength = 0;

        if (totalRelationships > 0) {
            let healthSum = 0;
            let trustSum = 0;
            let strengthSum = 0;

            this.relationships.forEach(rel => {
                healthSum += rel.getHealthScore();
                trustSum += rel.trustLevel;
                strengthSum += rel.strength;
            });

            avgHealth = healthSum / totalRelationships;
            avgTrust = trustSum / totalRelationships;
            avgStrength = strengthSum / totalRelationships;
        }

        // ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
        let typeDistribution = new Map<RelationshipType, number>();
        this.relationships.forEach(rel => {
            let count = typeDistribution.get(rel.relationshipType) || 0;
            typeDistribution.set(rel.relationshipType, count + 1);
        });

        // ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
        let stageDistribution = new Map<RelationshipStage, number>();
        this.relationships.forEach(rel => {
            let count = stageDistribution.get(rel.stage) || 0;
            stageDistribution.set(rel.stage, count + 1);
        });

        return {
            totalRelationships,
            totalInteractions,
            averageHealth: avgHealth,
            averageTrust: avgTrust,
            averageStrength: avgStrength,
            needingAttention: this.getRelationshipsNeedingAttention().length,
            typeDistribution: Object.fromEntries(typeDistribution),
            stageDistribution: Object.fromEntries(stageDistribution)
        };
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„
     */
    public getComprehensiveReport(): string {
        let stats = this.getStatistics();
        let report = `ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª\n`;
        report += `${"=".repeat(50)}\n\n`;

        report += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª: ${stats.totalRelationships}\n`;
        report += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª: ${stats.totalInteractions}\n`;
        report += `Ù…ØªÙˆØ³Ø· Ø§Ù„ØµØ­Ø©: ${(stats.averageHealth * 100).toFixed(0)}%\n`;
        report += `Ù…ØªÙˆØ³Ø· Ø§Ù„Ø«Ù‚Ø©: ${(stats.averageTrust * 100).toFixed(0)}%\n`;
        report += `Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚ÙˆØ©: ${(stats.averageStrength * 100).toFixed(0)}%\n`;
        report += `ØªØ­ØªØ§Ø¬ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Ù‹: ${stats.needingAttention}\n\n`;

        // Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
        let strongest = this.getStrongestRelationships(3);
        if (strongest.length > 0) {
            report += `ğŸŒŸ Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª:\n`;
            strongest.forEach((rel, i) => {
                report += `  ${i + 1}. ${rel.userId} - ØµØ­Ø©: ${(rel.getHealthScore() * 100).toFixed(0)}%\n`;
            });
            report += `\n`;
        }

        // Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Ù‹
        let needingAttention = this.getRelationshipsNeedingAttention();
        if (needingAttention.length > 0) {
            report += `âš ï¸ Ø¹Ù„Ø§Ù‚Ø§Øª ØªØ­ØªØ§Ø¬ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Ù‹:\n`;
            needingAttention.forEach((rel, i) => {
                report += `  ${i + 1}. ${rel.userId} - ØµØ­Ø©: ${(rel.getHealthScore() * 100).toFixed(0)}%\n`;
            });
        }

        return report;
    }
}

