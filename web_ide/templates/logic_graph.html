<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayan Logic Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .node text {
            pointer-events: none;
            font-size: 12px;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-4 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center gap-2">
            <h1 class="text-xl font-bold text-emerald-400">بيان <span class="text-slate-400 text-sm">المنطق
                    الرسومي</span></h1>
        </div>
        <div class="flex gap-2">
            <button onclick="runExample('simple')"
                class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded">مثال بسيط</button>
            <button onclick="runExample('syllogism')"
                class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded">القياس المنطقي</button>
            <button onclick="runExample('contradiction')"
                class="px-3 py-1 text-xs bg-rose-900/50 hover:bg-rose-800/50 text-rose-200 border border-rose-800 rounded">اختبار
                التناقض</button>
            <button onclick="runLogic()"
                class="px-4 py-1 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold shadow-lg transition-all">تحقق
                وتنفيذ ▶</button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Editor & Trace (Left Panel) -->
        <div class="w-1/3 flex flex-col border-l border-slate-700 bg-slate-800/50">
            <!-- Editor -->
            <div class="h-1/2 flex flex-col border-b border-slate-700">
                <div class="bg-slate-900 px-4 py-2 text-xs text-slate-400 font-mono border-b border-slate-800">EDITOR
                </div>
                <textarea id="codeEditor"
                    class="flex-1 bg-slate-900 p-4 font-mono text-sm resize-none focus:outline-none text-emerald-50"
                    dir="auto" placeholder="اكتب كود بيان هنا...">
مبرمج(أحمد).
يكتب_كود(X) :- مبرمج(X).
</textarea>
            </div>

            <!-- Trace & Output -->
            <div class="h-1/2 flex flex-col bg-slate-900">
                <div class="flex border-b border-slate-800">
                    <button onclick="showTab('trace')" id="btn-trace"
                        class="flex-1 py-2 text-xs font-bold bg-slate-800 text-emerald-400 border-b-2 border-emerald-500">مسار
                        التحقق</button>
                    <button onclick="showTab('output')" id="btn-output"
                        class="flex-1 py-2 text-xs font-bold text-slate-400 hover:bg-slate-800">المخرجات</button>
                </div>

                <div id="tab-trace" class="flex-1 overflow-auto p-4 font-mono text-xs space-y-1">
                    <div class="text-slate-500 italic">بانتظار التنفيذ...</div>
                </div>
                <div id="tab-output" class="hidden flex-1 overflow-auto p-4 font-mono text-sm text-emerald-300">
                </div>
            </div>
        </div>

        <!-- Graph Visualization (Right Panel) -->
        <div class="flex-1 relative bg-slate-950" id="graph-container">
            <div id="contradiction-alert"
                class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 bg-rose-900/90 border border-rose-500 text-rose-100 px-6 py-3 rounded-lg shadow-2xl z-20 flex items-center gap-3">
                <svg class="w-6 h-6 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
                <div>
                    <strong class="block font-bold">تناقض منطقي مكتشف!</strong>
                    <span id="contradiction-msg" class="text-sm opacity-90"></span>
                </div>
            </div>
            <svg id="graph-svg" class="w-full h-full"></svg>
        </div>

    </div>

    <script>
        // --- Examples ---
        const EXAMPLES = {
            simple: `مبرمج(أحمد).
يكتب_كود(X) :- مبرمج(X).`,
            syllogism: `إنسان(سقراط).
فان(X) :- إنسان(X).`,
            contradiction: `لون(السيارة, أحمر).
لون(السيارة, أزرق).`
        };

        function runExample(key) {
            document.getElementById('codeEditor').value = EXAMPLES[key];
            runLogic();
        }

        function showTab(tab) {
            document.getElementById('tab-trace').classList.add('hidden');
            document.getElementById('tab-output').classList.add('hidden');
            document.getElementById('btn-trace').className = "flex-1 py-2 text-xs font-bold text-slate-400 hover:bg-slate-800";
            document.getElementById('btn-output').className = "flex-1 py-2 text-xs font-bold text-slate-400 hover:bg-slate-800";

            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('btn-' + tab).className = "flex-1 py-2 text-xs font-bold bg-slate-800 text-emerald-400 border-b-2 border-emerald-500";
        }

        // --- D3 Graph Logic ---
        let simulation;

        function updateGraph(data) {
            const svg = d3.select("#graph-svg");
            svg.selectAll("*").remove(); // Clear previous

            const width = document.getElementById('graph-container').clientWidth;
            const height = document.getElementById('graph-container').clientHeight;

            // Arrow marker
            svg.append("defs").append("marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 20)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", "#999");

            const g = svg.append("g");

            // Zoom behavior
            svg.call(d3.zoom().on("zoom", (event) => {
                g.attr("transform", event.transform);
            }));

            simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(150))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = g.append("g")
                .selectAll("line")
                .data(data.links)
                .join("line")
                .attr("class", "link")
                .attr("marker-end", "url(#arrow)")
                .style("stroke-opacity", d => d.probability ? d.probability : 0.6)
                .style("stroke-dasharray", d => (d.probability && d.probability < 1.0) ? "5,5" : "none");

            const linkLabel = g.append("g")
                .selectAll("text")
                .data(data.links)
                .join("text")
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", "#aaa")
                .text(d => d.relationship + (d.probability && d.probability < 1.0 ? ` (${d.probability})` : ""));

            const node = g.append("g")
                .selectAll("g")
                .data(data.nodes)
                .join("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", d => d.group === 1 ? 15 : (d.group === 2 ? 10 : (d.group === 4 ? 12 : 8)))
                .attr("fill", d => d.group === 1 ? "#10b981" : (d.group === 2 ? "#3b82f6" : (d.group === 4 ? "#8b5cf6" : "#f59e0b")));

            node.append("text")
                .attr("dy", 25)
                .attr("text-anchor", "middle")
                .style("fill", "#e2e8f0")
                .text(d => d.label);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                linkLabel
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // --- API Interaction ---
        async function runLogic() {
            const code = document.getElementById('codeEditor').value;
            const traceDiv = document.getElementById('tab-trace');
            const outputDiv = document.getElementById('tab-output');
            const alertDiv = document.getElementById('contradiction-alert');

            traceDiv.innerHTML = '<div class="text-slate-500 animate-pulse">جاري التحليل...</div>';
            outputDiv.innerHTML = '';
            alertDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/ide/run_logic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();

                // Update Output
                outputDiv.innerText = result.output || "تم التنفيذ بنجاح.";

                // Update Trace
                traceDiv.innerHTML = result.trace.map(line =>
                    `<div class="border-l-2 border-slate-700 pl-2 hover:bg-slate-800/50 transition-colors">${line}</div>`
                ).join('');

                // Update Graph
                updateGraph(result.graph);

                // Check Contradictions
                if (result.contradictions && result.contradictions.length > 0) {
                    alertDiv.classList.remove('hidden');
                    document.getElementById('contradiction-msg').innerText = result.contradictions[0];
                    // Highlight trace
                    traceDiv.innerHTML += `<div class="mt-4 p-2 bg-rose-900/30 border border-rose-800 rounded text-rose-300 font-bold">⚠️ ${result.contradictions.length} تناقضات مكتشفة</div>`;
                }

            } catch (error) {
                console.error(error);
                traceDiv.innerHTML = `<div class="text-rose-500">خطأ في الاتصال: ${error.message}</div>`;
            }
        }
    </script>
</body>

</html>